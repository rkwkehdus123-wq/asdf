<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>메르시 힐량 계산기 & 최적 조합 추천</title>
  <!-- SEO: basic + OpenGraph + Twitter -->
  <link rel="canonical" href="https://majestic-cocada-b2c63d.netlify.app/">
  <meta name="description" content="오버워치 스타디움용 메르시 힐량 계산기 &amp; 최적 조합 추천. 예산·아이템·시나리오에 따라 HPS를 자동으로 최대화합니다.">
  <meta name="robots" content="index,follow">
  
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="메르시 힐량 계산기 & 최적 조합 추천">
  <meta property="og:description" content="예산과 아이템으로 HPS 최적화! 아마리/강화광 시나리오 반영, 즉시 계산.">
  <meta property="og:url" content="https://majestic-cocada-b2c63d.netlify.app/">
  <meta property="og:image" content="https://majestic-cocada-b2c63d.netlify.app/og.png">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="메르시 힐량 계산기 & 최적 조합 추천">
  <meta name="twitter:description" content="스타디움 메르시 유저를 위한 HPS 최적화 계산기.">
  <meta name="twitter:image" content="https://majestic-cocada-b2c63d.netlify.app/og.png">
  
  <!-- 구조화 데이터(JSON-LD) -->
  <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "메르시 힐량 계산기 & 최적 조합 추천",
    "url": "https://majestic-cocada-b2c63d.netlify.app/",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Web",
    "description": "오버워치 스타디움용 메르시 힐량 계산기. 예산/아이템/시나리오로 HPS를 극대화합니다.",
    "offers": {"@type": "Offer", "price": "0", "priceCurrency": "KRW"}
  }</script>
  <style>
    /* 폰트 및 기본 스타일 */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

    :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --primary-color: #0f3460;
        --secondary-color: #e94560;
        --text-color: #e0e0e0;
        --border-color: #2a3a5e;
        --green: #2ecc71;
        --blue: #3498db;
        --purple: #9b59b6;
    }

    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 1rem;
        line-height: 1.6;
    }

    /* 레이아웃 */
    .container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 1400px;
        margin: auto;
    }

    /* 데스크탑 화면에서 그리드 레이아웃 적용 */
    @media (min-width: 1024px) {
        .container {
            grid-template-columns: repeat(3, 1fr);
            grid-template-areas:
                "header header header"
                "controls scenario results"
                "items items items";
        }
        h1 { grid-area: header; }
        .controls { grid-area: controls; }
        .scenario { grid-area: scenario; }
        .item-list { grid-area: items; }
        .results { grid-area: results; }
    }

    /* 공통 요소 */
    h1, h2, h3 {
        color: var(--secondary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
        margin-top: 0;
    }
    h1 {
        text-align: center;
        font-size: 2.2rem;
        margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.4rem;
    }
    h2 small {
      font-size: 0.9rem;
      color: var(--text-color);
    }

    /* 카드 스타일 섹션 */
    .controls, .scenario, .item-list, .results {
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
    }

    /* 버튼 */
    button {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 1rem;
    }
    button:hover:not(:disabled) {
        background-color: #ff6b81;
        transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #recommend {
        width: 100%;
        margin-top: 1rem;
    }

    /* 입력 필드 & 라벨 */
    label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }
    input[type="number"], input[type="search"] {
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.5rem;
        font-size: 1rem;
    }
    input[type="number"] { width: 80px; }
    input[type="search"] { flex-grow: 1; max-width: 250px; }

    input[type="checkbox"], input[type="radio"] {
        accent-color: var(--secondary-color);
        width: 1.3em;
        height: 1.3em;
        cursor: pointer;
    }

    /* 시나리오 섹션 */
    .scenario-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    #toggleScenario {
        background: none;
        color: var(--text-color);
        padding: 0.2rem 0.5rem;
        align-self: flex-end; /* 오른쪽 정렬 */
        margin-bottom: -1rem; /* 콘텐츠와의 간격 조절 */
    }
    .scen-item label {
      font-size: 0.9rem;
    }

    /* 아이템 목록 */
    .item-list h2 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .item-list-actions {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
        flex-wrap: wrap;
    }
    #editItems {
        background: rgba(233, 69, 96, 0.16);
        border: 1px solid rgba(233, 69, 96, 0.35);
        color: var(--text-color);
    }
    #editItems:hover:not(:disabled) {
        background: rgba(233, 69, 96, 0.25);
    }
    .item-list.editing #editItems {
        background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 0 14px rgba(233, 69, 96, 0.35);
    }
    #toggleZeroStats {
        background: rgba(92, 141, 255, 0.16);
        border: 1px solid rgba(92, 141, 255, 0.35);
        color: var(--text-color);
    }
    #toggleZeroStats[aria-pressed="true"] {
        background: linear-gradient(135deg, rgba(92, 141, 255, 0.45), rgba(52, 94, 199, 0.65));
        border-color: transparent;
        color: #fff;
        box-shadow: 0 0 14px rgba(92, 141, 255, 0.35);
    }
    .item-category {
      margin-top: 2rem;
    }
    .item-category:first-child {
      margin-top: 1rem;
    }
    .item-category h3 {
      font-size: 1.6rem;
      color: var(--text-color);
      border-bottom-color: var(--secondary-color);
      margin-bottom: 1.2rem;
    }
    .item-list-content {
        display: grid;
        gap: 1.1rem;
        margin-top: 0;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        align-content: start;
    }
    @media (min-width: 1440px) {
        .item-list-content {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }
    }
    .item {
        position: relative;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.85rem 1.1rem;
        padding: 1.05rem 1.1rem 1.05rem 1.15rem;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: linear-gradient(135deg, rgba(15, 52, 96, 0.78), rgba(22, 33, 62, 0.65));
        --item-glow: 0 12px 28px rgba(0, 0, 0, 0.45);
        box-shadow: var(--item-glow);
        transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease, order 0.3s ease;
        overflow: hidden;
    }
    .item::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), transparent 60%);
        opacity: 0.45;
        pointer-events: none;
    }
    .item:hover {
        transform: translateY(-3px);
        box-shadow: var(--item-glow), 0 16px 32px rgba(15, 52, 96, 0.45);
    }
    .item.green { border-left: 6px solid var(--green); --item-glow: 0 12px 26px rgba(46, 204, 113, 0.18); }
    .item.blue { border-left: 6px solid var(--blue); --item-glow: 0 12px 26px rgba(52, 152, 219, 0.18); }
    .item.purple { border-left: 6px solid var(--purple); --item-glow: 0 12px 26px rgba(155, 89, 182, 0.18); }
    .item:has(.include:checked) {
        box-shadow: var(--item-glow), 0 0 0 1px rgba(233, 69, 96, 0.45), 0 0 20px rgba(233, 69, 96, 0.32);
    }
    .item:has(.pin:checked) {
        box-shadow: var(--item-glow), 0 0 0 1px rgba(241, 196, 15, 0.55), 0 0 26px rgba(241, 196, 15, 0.4);
    }
    .item.green::after,
    .item.blue::after,
    .item.purple::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        opacity: 0.18;
        pointer-events: none;
    }
    .item.green::after { background: radial-gradient(circle at top right, rgba(46,204,113,0.55), transparent 55%); }
    .item.blue::after { background: radial-gradient(circle at top right, rgba(52,152,219,0.55), transparent 55%); }
    .item.purple::after { background: radial-gradient(circle at top right, rgba(155,89,182,0.55), transparent 55%); }

    @media (max-width: 640px) {
        .item {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        .item-controls {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 0.75rem;
            grid-row: auto;
        }
    }

    .item-visibility-toggle {
        position: absolute;
        top: 0.45rem;
        right: 0.45rem;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(15, 52, 96, 0.45);
        color: #fff;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        z-index: 2;
    }
    .item-visibility-toggle:hover {
        background: rgba(233, 69, 96, 0.45);
        border-color: rgba(233, 69, 96, 0.65);
    }
    .item-visibility-toggle.is-hidden {
        background: rgba(233, 69, 96, 0.3);
        border-color: rgba(233, 69, 96, 0.5);
    }
    .item-list.editing .item-visibility-toggle {
        opacity: 1;
        pointer-events: auto;
    }
    .item--hidden {
        opacity: 0.38;
        filter: grayscale(55%);
    }
    .item--collapsed {
        display: none !important;
    }

    .item-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 0.55rem;
        grid-row: span 2;
        z-index: 1;
    }
    .item-controls label {
        margin-bottom: 0;
        font-size: 0.95rem;
    }
    .item-controls label.chip {
        padding: 0.45rem 0.9rem;
        font-size: 0.9rem;
        letter-spacing: -0.01em;
        background: rgba(15, 52, 96, 0.4);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 10px 16px rgba(0, 0, 0, 0.25);
    }
    .item-controls label.chip span {
        font-weight: 600;
    }
    .item-label {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        font-weight: 500;
        text-align: left;
        line-height: 1.45;
        z-index: 1;
    }
    .item-label .item-name {
        display: inline-flex;
        align-items: baseline;
        gap: 0.4rem;
        font-weight: 700;
        font-size: 1.05rem;
        color: #ffffff;
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
    }
    .item-label .item-price {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(15, 52, 96, 0.55);
        color: rgba(224, 224, 224, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }
    .item.green .item-label .item-price { color: rgba(214, 255, 227, 0.92); border-color: rgba(46, 204, 113, 0.35); background: rgba(46, 204, 113, 0.14); }
    .item.blue .item-label .item-price { color: rgba(214, 235, 255, 0.92); border-color: rgba(52, 152, 219, 0.35); background: rgba(52, 152, 219, 0.16); }
    .item.purple .item-label .item-price { color: rgba(238, 218, 255, 0.92); border-color: rgba(155, 89, 182, 0.35); background: rgba(155, 89, 182, 0.16); }
    .item-label .item-stats {
        font-size: 0.95rem;
        color: rgba(224, 224, 224, 0.85);
    }
    .item-label .item-stats .stat-highlight {
        color: #ffffff;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.07);
        padding: 0.1em 0.35em;
        border-radius: 5px;
        margin: 0 0.1em;
    }
    .item-label small {
        display: inline-block;
        margin-top: 0.2rem;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
    }

    /* 결과 & 테이블 */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    th, td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    th {
        color: var(--secondary-color);
    }
    #bestCombo, #totalPrice, #totalWP, #totalAS, #healing {
      transition: opacity 0.3s ease;
    }
    .is-fading-out {
        opacity: 0 !important;
    }
    #totalPrice, #totalWP, #totalAS { font-size: 1.2rem; font-weight: 700; color: #ffffff; text-shadow: none; }
    /* 강조 스타일: 예상 힐량 하이라이트 */
    .healing-row { background: none; }
    .healing-row th, .healing-row td { border-bottom: none; padding-top: 0.5rem; padding-bottom: 0.5rem; }
    #healing {
      font-size: 2.4rem;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 107, 129, 0.7);
      white-space: nowrap;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      padding: 0.18rem 0.6rem 0.26rem 0.6rem;
      margin-right: 0.35rem;
      background-image: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.35), inset 0 1px 1px rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    }
    .healing-unit { opacity: 0.95; white-space: nowrap; }
    /* 결과 표는 항상 한 줄로 표시 */
    .results table th, .results table td { white-space: nowrap; }
    @media (max-width: 480px) { #healing { font-size: 2rem; padding: 0.14rem 0.5rem 0.22rem 0.5rem; } }
  
    /* =============================
       THEME-CONSISTENT FORM CONTROLS
       ============================= */

    /* Focus ring for keyboard users */
    :where(input,button):focus-visible { outline: 2px solid var(--secondary-color); outline-offset: 2px; }

    /* ---------- ITEM LIST: include/pin chips (pill buttons) ---------- */
    .item-list .item-controls { display:flex; flex-direction:column; align-items:flex-start; gap: .4rem; }
    .item-list .item-controls input[type="checkbox"]{ position:absolute; opacity:0; width:0; height:0; }
    .item-list .item-controls label.chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .95rem; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(12,26,54,.65); color:var(--text-color); cursor:pointer; user-select:none; font-size:.88rem; font-weight:600; line-height:1; white-space:nowrap; transition:background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .05s ease; }
    .item-list .item-controls label.chip:hover{ border-color:rgba(124,163,255,.55); background:rgba(33,56,102,.75); }
    .item-list .item-controls label.chip:active{ transform:scale(.97); }
    .item-list .item-controls label.chip::before{ content:""; width:.95rem; height:.95rem; display:inline-block; background: #95a5b6; mask-size:contain; mask-repeat:no-repeat; mask-position:center; -webkit-mask-size:contain; -webkit-mask-repeat:no-repeat; -webkit-mask-position:center; filter: drop-shadow(0 0 6px rgba(149,165,182,.5)); }
    /* include icon (check) */
    .item-list .item-controls label.include-chip::before{ mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M9 16.2 4.8 12l-1.8 1.8L9 19.8 21 7.8 19.2 6z"/></svg>'); -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M9 16.2 4.8 12l-1.8 1.8L9 19.8 21 7.8 19.2 6z'/></svg>"); }
    /* pin icon (star) */
    .item-list .item-controls label.pin-chip::before{ mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="m12 17.3-5.56 3.27 1.48-6.36L3 9.97l6.56-.56L12 3.5l2.44 5.91 6.56.56-4.92 4.24 1.48 6.36z"/></svg>'); -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='m12 17.3-5.56 3.27 1.48-6.36L3 9.97l6.56-.56L12 3.5l2.44 5.91 6.56.56-4.92 4.24 1.48 6.36z'/></svg>"); }
    /* checked state */
    /* per-type checked states */
    .item-list .item-controls label.include-chip:has(input:checked){ background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%); border-color: transparent; color:#fff; box-shadow: 0 0 12px rgba(233,69,96,.35); }
    .item-list .item-controls label.include-chip:has(input:checked)::before{ background:#fff; }
    .item-list .item-controls label.pin-chip:has(input:checked){ background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); border-color: rgba(241,196,15,.85); color:#1a1a2e; box-shadow: 0 0 14px rgba(241,196,15,.45), 0 0 28px rgba(241,196,15,.25); }
    .item-list .item-controls label.pin-chip:has(input:checked)::before{ background:#1a1a2e; }
    .item-list .item-controls label.chip:has(input:checked)::before{ background:#fff; }

    /* ---------- SCENARIO: radio group & checkbox toggles as pills ---------- */
    .stack-scenarios .scen-item { display: inline-block; }
    .stack-scenarios .scen-item input[type="radio"],
    .stack-scenarios .scen-item input[type="checkbox"] { 
      position: absolute; opacity: 0; width: 0; height: 0; 
    }
    .stack-scenarios .scen-item input[type="radio"] + label,
    .stack-scenarios .scen-item input[type="checkbox"] + label {
      display: inline-block; margin: .25rem .35rem .25rem 0; padding: .4rem .8rem;
      border: 1px solid var(--border-color); border-radius: 999px;
      background: rgba(255,255,255,0.04); color: var(--text-color);
      transition: background .2s ease, border-color .2s ease, transform .05s ease, box-shadow .2s ease;
      cursor: pointer; user-select: none; font-size: .95rem;
    }
    .stack-scenarios .scen-item input[type="radio"] + label:hover,
    .stack-scenarios .scen-item input[type="checkbox"] + label:hover {
      border-color: rgba(233,69,96,0.55); background: rgba(233,69,96,0.08);
    }
    .stack-scenarios .scen-item input[type="radio"]:focus-visible + label,
    .stack-scenarios .scen-item input[type="checkbox"]:focus-visible + label { 
      box-shadow: 0 0 0 3px rgba(233,69,96,0.35); 
    }
    .stack-scenarios .scen-item input[type="radio"]:checked + label,
    .stack-scenarios .scen-item input[type="checkbox"]:checked + label {
      color: #fff; border-color: rgba(233,69,96,0.65);
      background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35), 0 0 0 2px rgba(233,69,96,0.22) inset;
    }

    /* ---------- SCENARIO: low-HP switch ---------- */
    .am-scenarios .scen-item { position: relative; }
    .am-scenarios .scen-item input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .am-scenarios .scen-item input[type="checkbox"] + label {
      position: relative; padding-left: 3.2rem; min-height: 1.6rem; display: inline-flex; align-items: center;
    }
    .am-scenarios .scen-item input[type="checkbox"] + label::before {
      content: ""; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
      width: 2.6rem; height: 1.4rem; border-radius: 999px;
      background: #0b1530; border: 1px solid var(--border-color);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.5);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .am-scenarios .scen-item input[type="checkbox"] + label::after {
      content: ""; position: absolute; left: .18rem; top: 50%; transform: translateY(-50%);
      width: 1.05rem; height: 1.05rem; border-radius: 50%;
      background: #233449; box-shadow: 0 2px 4px rgba(0,0,0,.4);
      transition: left .22s ease, background .2s ease;
    }
    .am-scenarios .scen-item input[type="checkbox"]:checked + label::before {
      background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%); border-color: transparent;
      box-shadow: 0 0 12px rgba(233,69,96,0.35) inset;
    }
    .am-scenarios .scen-item input[type="checkbox"]:checked + label::after { left: 1.35rem; background: #fff; }

    /* Ghost style for scenario toggler */
    #toggleScenario { border: 1px solid var(--border-color); border-radius: 999px; }
    #toggleScenario:hover { border-color: #3c4f7f; }

  
    /* ---------- LAYOUT: radio pills as responsive flex rows (2 columns) ---------- */
    .stack-scenarios { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: .6rem; align-items: stretch; }
    .stack-scenarios > h3 { grid-column: 1 / -1; margin-bottom: .25rem; }
    .stack-scenarios .scen-item { display: block; margin: 0;}
    .stack-scenarios .scen-item input[type="radio"] + label,
    .stack-scenarios .scen-item input[type="checkbox"] + label {
      display: flex; align-items: center; justify-content: center; width: 100%;
      margin: 0; min-height: 44px; box-sizing: border-box; padding: .6rem .9rem;
    }
    @media (max-width: 560px) { .stack-scenarios { grid-template-columns: 1fr; } }

  
    /* ---- Micro interactions & responsive enhancements ---- */
    @keyframes pop { 0% { transform: scale(.98); } 100% { transform: scale(1); } }
    .stack-scenarios .scen-item input[type="radio"]:checked + label,
    .stack-scenarios .scen-item input[type="checkbox"]:checked + label { 
      animation: pop 120ms ease-out; 
    }
    .item-list .item-controls input[type="checkbox"]:checked { animation: pop 120ms ease-out; }
    @media (min-width:1280px) { .stack-scenarios { grid-template-columns: repeat(2, minmax(0,1fr)); } }

    /* Tooltip(help) */
    .am-scenarios .scen-item label .help { display:inline-flex; align-items:center; justify-content:center; width:1.05rem; height:1.05rem; margin-left:.35rem; border-radius:50%; border:1px solid var(--border-color); background:rgba(255,255,255,.06); font-weight:700; font-size:.78rem; line-height:1; cursor:help; }

  </style>
</head>
<body>
<div class="container">
  <h1>메르시 힐량 계산기 & 최적 조합 추천</h1>
  
  <div class="controls">
    <h2>기본 설정</h2>
    <label>보유 재화: <input type="number" id="budget" value="20000" min="0" step="1"></label>
    <label>아이템 수: <input type="number" id="maxItems" value="6" min="1" max="12"></label>
    <button id="recommend">최적 조합 추천</button>
  </div>

  <div class="scenario">
    <button id="toggleScenario">▼ 접기</button>
    <h2>시나리오 설정</h2>
    <div class="scenario-content">
      <div class="am-scenarios">
        <h3>아마리 해독제</h3>
        <div class="scen-item"><input type="checkbox" id="chkLowHp"><label for="chkLowHp">저체력 회복 (HP&lt;50%, 무기 치유량 +15%)<span class="help" title="HP 50% 미만일 때 메르시 무기 치유량에 +15%가 곱연산으로 추가됩니다.">?</span></label></div>
      </div>
      <div class="am-scenarios">
        <h3>부상자 분류소</h3>
        <div class="scen-item">
          <input type="checkbox" id="chkTriage">
          <label for="chkTriage">치유량 25%증가</label>
        </div>
      </div>
      <div class="stack-scenarios">
        <h3>강화광 가속기</h3>
        <div class="scen-item"><input type="radio" name="stack" value="stack0" id="stack-none" checked><label for="stack-none">중첩 없음 (+0% 무공)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack1" id="stack1"><label for="stack1">1중첩 (+5% 무공)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack2" id="stack2"><label for="stack2">2중첩 (+10% 무공)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack3" id="stack3"><label for="stack3">3중첩 (+15% 무공)</label></div>
      </div>
      <div class="stack-scenarios">
        <h3>조건부 효과</h3>
        <div class="scen-item">
          <input type="checkbox" id="chkVanadium">
          <label for="chkVanadium">바나듐 주사</label>
        </div>
        <div class="scen-item">
          <input type="checkbox" id="chkCrusader">
          <label for="chkCrusader">성전사 유압 시스템</label>
        </div>
        <div class="scen-item">
          <input type="checkbox" id="chkSuperSerum">
          <label for="chkSuperSerum">슈퍼 혈청</label>
        </div>
      </div>
    </div>
  </div>

  <div class="results">
    <h3>추천 조합</h3>
    <table>
      <thead><tr><th>아이템</th><th>가격</th><th>무공%</th><th>공속%</th></tr></thead>
      <tbody id="bestCombo"><tr><td colspan="4">추천 버튼을 눌러주세요</td></tr></tbody>
    </table>
    
    <h2 style="margin-top: 1.5rem;">결과 요약</h2>
    <table>
      <tr class="healing-row"><th>예상 힐량</th><td><span id="healing">60.0</span></td><th class="healing-unit">hps</th></tr>
      <tr><th>총 비용</th><td id="totalPrice">0</td><th>재화</th></tr>
      <tr><th>총 무공</th><td id="totalWP">0</td><th>%</th></tr>
      <tr><th>총 공속</th><td id="totalAS">0</td><th>%</th></tr>
    </table>
  </div>

  <div class="item-list">
    <h2>아이템 목록 <small>(포함/고정 토글)</small>
      <div class="item-list-actions">
        <input type="search" id="itemSearch" placeholder="아이템 검색...">
        <button id="editItems" type="button">아이템 목록 편집</button>
        <button id="toggleZeroStats" type="button" class="toggle-zero-stats" hidden aria-pressed="false">무공/공속 없는 아이템 숨기기</button>
        <button id="calcItems" type="button">선택 아이템 계산</button>
      </div>
    </h2>

    <div id="item-container">
      <!-- Items will be injected here by JavaScript -->
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- 요소 가져오기 ---
    const budgetInput = document.getElementById('budget');
    const maxItemsInput = document.getElementById('maxItems');
    const recommendBtn = document.getElementById('recommend');
    const calcItemsBtn = document.getElementById('calcItems');
    const toggleScenarioBtn = document.getElementById('toggleScenario');
    const scenarioContent = document.querySelector('.scenario-content');
    const itemContainer = document.getElementById('item-container');
    const itemSearchInput = document.getElementById('itemSearch');

    let includeInputs = [];
    let pinInputs = [];
    const lowHpInput = document.getElementById('chkLowHp');
    const stackRadios = document.querySelectorAll('input[name="stack"]');
    const vanadiumToggle = document.getElementById('chkVanadium');
    const crusaderToggle = document.getElementById('chkCrusader');
    const superSerumToggle = document.getElementById('chkSuperSerum');
    const triageToggle = document.getElementById('chkTriage');
    const editItemsBtn = document.getElementById('editItems');
    const toggleZeroStatsBtn = document.getElementById('toggleZeroStats');
    const itemListEl = document.querySelector('.item-list');
    let itemCards = [];

    const totalPriceEl = document.getElementById('totalPrice');
    const totalWPEl = document.getElementById('totalWP');
    const totalASEl = document.getElementById('totalAS');
    const healingEl = document.getElementById('healing');
    const bestComboTbody = document.getElementById('bestCombo');

    let isCalculating = false;

    const itemData = {
      weapon: [
        { name: '무기 기름칠', price: 1000, wp: 0, as: 5, rarity: 'green', description: '공속+5%' },
        { name: '보정기', price: 1000, wp: 5, as: 0, rarity: 'green', description: '무공+5%' },
        { name: '부품 시장 발사 핀', price: 3750, wp: 0, as: 10, rarity: 'blue', description: '공속+10%' },
        { name: '고급 나노생물학', price: 4000, wp: 5, as: 10, rarity: 'blue', description: '무공+5%, 공속+10%' },
        { name: '공중 기동기', price: 4000, wp: 5, as: 10, rarity: 'blue', description: '무공+5%, 공속+10%(고정 전용)', fixedOnly: true },
        { name: '꽉 채운 잔', price: 4500, wp: 0, as: 5, rarity: 'blue', description: '공속+5%' },
        { name: '차가운 냉각수', price: 5500, wp: 10, as: 0, rarity: 'blue', description: '무공+10%' },
        { name: '탈론 개조 모듈', price: 6000, wp: 15, as: 0, rarity: 'blue', description: '무공+15%' },
        { name: '공중 조난자', price: 9000, wp: 0, as: 10, rarity: 'purple', description: '공속+10%' },
        { name: '코드브레이커', price: 10000, wp: 15, as: 0, rarity: 'purple', description: '무공+15%' },
        { name: '회수 산탄', price: 9000, wp: 0, as: 10, rarity: 'purple', description: '공속+10%' },
        { name: '볼스카야 군수품', price: 9500, wp: 0, as: 10, rarity: 'purple', description: '공속+10%' },
        { name: '무기 재머', price: 10000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '사령관의 탄창', price: 10000, wp: 0, as: 10, rarity: 'purple', description: '공속+10%' },
        { name: '카두세우스 연장기', price: 10000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '천상의 탄창', price: 10000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '강화광 가속기', price: 11000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '부스터 제트', price: 11000, wp: 0, as: 20, rarity: 'purple', description: '공속+20%' },
        { name: '아마리의 해독제', price: 11000, wp: 15, as: 0, rarity: 'purple', description: '무공+15% (HP<50%)' },
        { name: '엘사가 제압기', price: 11000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '거미의 눈', price: 14000, wp: 25, as: 0, rarity: 'purple', description: '무공+25%' },
        { name: '종결자', price: 14500, wp: 20, as: 0, rarity: 'purple', description: '무공+20%' },
      ],
      tech: [
        { name: '수상쩍은 장관', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '충전 판갑', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '파워 전술', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '승리의 태도', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '맞춤형 개머리판', price: 3750, wp: 5, as: 0, rarity: 'blue', description: '무공+5%' },
        { name: '생체광 오버플로', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '손목 싸개', price: 4000, wp: 0, as: 10, rarity: 'blue', description: '공속+10%' },
        { name: '스카이라인 나노머신', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '쓰레기촌 뭐더라', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '에너지 충전 손목 방어구', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '장거리 날개', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%'},
        { name: '다용도 도구', price: 4500, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '활력 증폭기', price: 5000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '나노 콜라', price: 6000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '축복받은 부스터', price: 9000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%'},
        { name: '음파 재충전', price: 9000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '3연속 토미건 발사', price: 9500, wp: 0, as: 10, rarity: 'purple', description: '공속+10%' },
        { name: '루메리코 융합 기관포', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '생체기술 극대화', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '초굴근', price: 10000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '촉매 수정', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '부활 거리 측정기', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%'},
        { name: '사이버베놈', price: 10500, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '광채 눈동자', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '액체질소', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '여우의 징표', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '천사의 곡예', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%'},
        { name: '챔피언의 도구', price: 14000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
      ],
      survival: [
        { name: '러닝화', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '전투식량', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '전해액', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '탄도 완화', price: 1000, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '반사 코팅', price: 1500, wp: 0, as: 0, rarity: 'green', description: '' },
        { name: '아드레날린 주사', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '응급 치료 키트', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '장갑 조끼', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '흡수 장갑', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '강철 눈', price: 3750, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '강화 티타늄', price: 3750, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '비슈카르 콘덴서', price: 3750, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '완충재', price: 3750, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: 'E생명력', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '철갑 배기구', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '공기역학적 깃털', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%'},
        { name: '천사의 레저 복장', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%'},
        { name: '피의 구속', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '성전사 유압 시스템', price: 4500, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%', note: '조건부 활성화 시 공속+5%' },
        { name: '메카 Z 시리즈', price: 5000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '유전학자의 약병', price: 9000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '신성한 개입', price: 9500, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '오버드라이브 핵', price: 9500, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '뤼스퉁 폰 빌헬름', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '바나듐 주사', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%', note: '조건부 활성화 시 무공+10%, 공속+10%' },
        { name: '어둠의 건틀릿', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '화성의 수리공', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '환영 유입', price: 10000, wp: 10, as: 0, rarity: 'purple', description: '무공+10%' },
        { name: '연쇄 유발기', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%'},
        { name: '성운 전도', price: 11000, wp: 5, as: 0, rarity: 'purple', description: '무공+5%' },
        { name: '오군디무 감소장', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
      ],
      gadget: [
        { name: '오라 격퇴', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '방벽 파편', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '외골격 스프링', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '깃털 달린 밑창', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '구급상자', price: 1500, wp: 0, as: 0, rarity: 'green', description: '무공+0%, 공속+0%' },
        { name: '질주 스케이트', price: 3750, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '야전 지원', price: 4000, wp: 5, as: 0, rarity: 'blue', description: '무공+5%, 공속+0%' },
        { name: '여우님 파편', price: 4000, wp: 0, as: 0, rarity: 'blue', description: '무공+0%, 공속+0%' },
        { name: '카네자카 부적', price: 9000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '제트 스케이팅', price: 9500, wp: 10, as: 0, rarity: 'purple', description: '무공+10%, 공속+0%' },
        { name: '괴저 방지제', price: 10000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '슈퍼 혈청', price: 10000, wp: 0, as: 10, rarity: 'purple', description: '무공+0%, 공속+10%', note: '조건부 활성화 시 무공-15%, 공속+50%' },
        { name: '거상 핵', price: 11000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
        { name: '재정비', price: 13000, wp: 0, as: 0, rarity: 'purple', description: '무공+0%, 공속+0%' },
      ],
    };

    const slugify = (name = '') => name.replace(/\s+/g, '');

    function createItemCard(item, categoryKey) {
      const card = document.createElement('div');
      const idBase = item.id || slugify(item.name);
      card.className = `item ${item.rarity}`;
      card.id = `item-${idBase}`;
      card.dataset.name = item.name;
      card.dataset.price = String(item.price);
      card.dataset.wp = String(item.wp);
      card.dataset.as = String(item.as);
      card.dataset.category = categoryKey;
      card.dataset.rarity = item.rarity;
      if (item.fixedOnly) {
        card.dataset.fixedOnly = 'true';
      }

      const controls = document.createElement('div');
      controls.className = 'item-controls';

      const includeLabel = document.createElement('label');
      includeLabel.title = '포함';
      includeLabel.className = 'chip include-chip';
      includeLabel.innerHTML = '<input type="checkbox" class="include"><span>포함</span>';

      const pinLabel = document.createElement('label');
      pinLabel.title = '고정';
      pinLabel.className = 'chip pin-chip';
      pinLabel.innerHTML = '<input type="checkbox" class="pin"><span>고정</span>';

      controls.append(includeLabel, pinLabel);

      const label = document.createElement('span');
      label.className = 'item-label';
      let labelHtml = `${item.name} ${item.price.toLocaleString()}<br>${item.description}`;
      if (item.note) {
        labelHtml += `<br><small>${item.note}</small>`;
      }
      label.innerHTML = labelHtml;

      card.append(controls, label);
      return card;
    }

    function renderItems() {
      itemContainer.innerHTML = ''; // Clear previous items
      const categoryMap = {
        weapon: '무기',
        tech: '기술',
        survival: '생존',
        gadget: '가젯'
      };

      Object.entries(itemData).forEach(([categoryKey, items]) => {
        const categoryWrapper = document.createElement('div');
        categoryWrapper.className = 'item-category';

        const categoryTitle = document.createElement('h3');
        categoryTitle.textContent = categoryMap[categoryKey];
        categoryWrapper.appendChild(categoryTitle);

        const contentGrid = document.createElement('div');
        contentGrid.className = 'item-list-content';
        
        items.forEach(item => {
          contentGrid.appendChild(createItemCard(item, categoryKey));
        });

        categoryWrapper.appendChild(contentGrid);
        itemContainer.appendChild(categoryWrapper);
      });
    }

    function refreshItemReferences() {
      includeInputs = Array.from(document.querySelectorAll('.include'));
      pinInputs = Array.from(document.querySelectorAll('.pin'));
      itemCards = Array.from(document.querySelectorAll('.item-list .item'));
    }

    renderItems();
    refreshItemReferences();

    // --- 상수 정의 ---
    const baseHealing = 60;
    let debounceTimer;
    let hiddenItemNames = new Set();
    let isEditingItems = false;

    includeInputs.forEach((input, idx) => {
      const data = getItemData(input);
      input.dataset.name = data.name;
      if (pinInputs[idx]) {
        pinInputs[idx].dataset.name = data.name;
      }
    });

    function setupItemVisibilityControls() {
      itemCards.forEach(item => {
        if (item.querySelector('.item-visibility-toggle')) return;
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'item-visibility-toggle';
        toggleBtn.textContent = '👀';
        const labelName = item.dataset.name || '아이템';
        toggleBtn.title = '아이템 표시/숨김 전환';
        toggleBtn.setAttribute('aria-label', `${labelName} 표시/숨김 전환`);
        toggleBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const willHide = item.dataset.hidden === 'true' ? false : true;
          setItemHiddenState(item, willHide);
          saveState();
        });
        item.insertAdjacentElement('afterbegin', toggleBtn);
      });
    }

    function syncItemDisplay(item) {
      const isHidden = item.dataset.hidden === 'true';
      if (isEditingItems) {
        item.classList.remove('item--collapsed');
        item.classList.toggle('item--hidden', isHidden);
      } else {
        item.classList.remove('item--hidden');
        item.classList.toggle('item--collapsed', isHidden);
      }
      const toggleBtn = item.querySelector('.item-visibility-toggle');
      if (toggleBtn) {
        toggleBtn.setAttribute('aria-pressed', isHidden ? 'true' : 'false');
        toggleBtn.classList.toggle('is-hidden', isHidden);
      }
    }

    function setItemHiddenState(item, hidden) {
      if (!item) return;
      const name = item.dataset.name || '';
      if (hidden) {
        if (name) hiddenItemNames.add(name);
      } else if (name) {
        hiddenItemNames.delete(name);
      }
      const currentlyHidden = item.dataset.hidden === 'true';
      item.dataset.hidden = hidden ? 'true' : 'false';
      if (hidden === currentlyHidden) {
        syncItemDisplay(item);
        updateZeroStatButtonState();
        return;
      }
      syncItemDisplay(item);
      updateZeroStatButtonState();
    }

    function isZeroStatItem(item) {
      if (!item) return false;
      const wp = Number(item.dataset.wp);
      const as = Number(item.dataset.as);
      const wpVal = Number.isFinite(wp) ? wp : 0;
      const asVal = Number.isFinite(as) ? as : 0;
      return wpVal === 0 && asVal === 0;
    }

    function getZeroStatItems() {
      return itemCards.filter(isZeroStatItem);
    }

    function updateZeroStatButtonState() {
      if (!toggleZeroStatsBtn) return;
      const zeroItems = getZeroStatItems();
      if (zeroItems.length === 0) {
        toggleZeroStatsBtn.disabled = true;
        toggleZeroStatsBtn.dataset.active = 'false';
        toggleZeroStatsBtn.setAttribute('aria-pressed', 'false');
        toggleZeroStatsBtn.textContent = '무공/공속 없는 아이템 숨기기';
        toggleZeroStatsBtn.title = '무공과 공속이 모두 0인 아이템이 없습니다.';
        return;
      }

      toggleZeroStatsBtn.disabled = false;
      const allHidden = zeroItems.every(item => item.dataset.hidden === 'true');
      toggleZeroStatsBtn.dataset.active = allHidden ? 'true' : 'false';
      toggleZeroStatsBtn.setAttribute('aria-pressed', allHidden ? 'true' : 'false');
      toggleZeroStatsBtn.textContent = allHidden ? '숨긴 아이템 복원' : '무공/공속 없는 아이템 숨기기';
      toggleZeroStatsBtn.title = allHidden ? '숨긴 아이템을 다시 표시합니다.' : '무공과 공속이 모두 0인 아이템을 숨깁니다.';
    }

    function refreshItemVisibility() {
      itemCards.forEach(syncItemDisplay);
      updateZeroStatButtonState();
    }

    function applyHiddenStateFromStorage() {
      itemCards.forEach(item => {
        const name = item.dataset.name || '';
        const shouldHide = name ? hiddenItemNames.has(name) : false;
        setItemHiddenState(item, shouldHide);
      });
      refreshItemVisibility();
    }

    function enterEditMode() {
      if (!itemListEl) return;
      isEditingItems = true;
      itemListEl.classList.add('editing');
      if (editItemsBtn) {
        editItemsBtn.textContent = '편집 완료';
        editItemsBtn.setAttribute('aria-pressed', 'true');
      }
      if (toggleZeroStatsBtn) {
        toggleZeroStatsBtn.hidden = false;
        updateZeroStatButtonState();
      }
      refreshItemVisibility();
    }

    function exitEditMode() {
      if (!itemListEl) return;
      isEditingItems = false;
      itemListEl.classList.remove('editing');
      if (editItemsBtn) {
        editItemsBtn.textContent = '아이템 목록 편집';
        editItemsBtn.setAttribute('aria-pressed', 'false');
      }
      if (toggleZeroStatsBtn) {
        toggleZeroStatsBtn.hidden = true;
      }
      refreshItemVisibility();
    }

    function toggleEditMode() {
      if (isEditingItems) {
        exitEditMode();
      } else {
        enterEditMode();
      }
    }

    // --- 상태 저장(LocalStorage) ---
    const STORAGE_KEY = 'mercy_heal_calc_v1';

    function saveState() {
      try {
        const includes = includeInputs.filter(i => i.checked).map(i => i.dataset.name).filter(Boolean);
        const pins = pinInputs.map((p, idx) => p.checked ? includeInputs[idx].dataset.name : null).filter(Boolean);
        const stackSel = document.querySelector('input[name="stack"]:checked');
        const hiddenItems = itemCards
          .filter(item => item.dataset.hidden === 'true')
          .map(item => item.dataset.name)
          .filter(Boolean);
        const data = {
          budget: +budgetInput.value || 0,
          maxItems: +maxItemsInput.value || 6,
          lowHp: !!lowHpInput.checked,
          stackId: stackSel ? stackSel.id : 'stack-none',
          includes,
          pins,
          vanadiumActive: vanadiumToggle.checked,
          crusaderActive: crusaderToggle.checked,
          superSerumActive: superSerumToggle ? superSerumToggle.checked : false,
          triageActive: triageToggle.checked,
          hiddenItems,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) { /* noop */ }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.budget != null) budgetInput.value = data.budget;
        if (data.maxItems != null) maxItemsInput.value = data.maxItems;
        if (typeof data.lowHp === 'boolean') lowHpInput.checked = data.lowHp;
        if (data.stackId) {
          const r = document.getElementById(data.stackId);
          if (r) r.checked = true;
        }
        if (typeof data.vanadiumActive === 'boolean') vanadiumToggle.checked = data.vanadiumActive;
        if (typeof data.crusaderActive === 'boolean') crusaderToggle.checked = data.crusaderActive;
        if (typeof data.superSerumActive === 'boolean' && superSerumToggle) superSerumToggle.checked = data.superSerumActive;
        if (typeof data.triageActive === 'boolean') triageToggle.checked = data.triageActive;

        includeInputs.forEach(i => i.checked = false);
        pinInputs.forEach(p => p.checked = false);
        if (Array.isArray(data.includes)) {
          includeInputs.forEach(i => { if (data.includes.includes(i.dataset.name)) i.checked = true; });
        }
        if (Array.isArray(data.pins)) {
          pinInputs.forEach((p, idx) => { if (data.pins.includes(includeInputs[idx].dataset.name)) p.checked = true; });
        }
        if (Array.isArray(data.hiddenItems)) {
          hiddenItemNames = new Set(data.hiddenItems);
        } else {
          hiddenItemNames = new Set();
        }
      } catch (e) { /* noop */ }
    }

    // --- 초기화 함수 ---
    function initialize() {
        formatItemPrices();
        setupItemVisibilityControls();
        addEventListeners();
        loadState();
        enforceFixedOnlyRules();
        applyHiddenStateFromStorage();
        exitEditMode();
        calculate(true); // 초기 로드 시 즉시 계산
    }

    /** 아이템 목록의 가격에 콤마를 추가하고 괄호를 제거합니다. */
    function formatItemPrices() {
        const escapeHtml = (str = '') => str.replace(/[&<>"']/g, ch => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
        }[ch] || ch));
        
        document.querySelectorAll('.item').forEach(item => {
            const label = item.querySelector('.item-label');
            if (!label) return;

            const original = label.dataset.original ?? label.innerHTML;
            label.dataset.original = original;

            const segments = original.split('<br>');
            const firstLine = (segments.shift() || '').trim();
            let statsHtml = segments.join('<br>').trim();
            
            statsHtml = statsHtml.replace(/(무공\s*[+-]?\s*\d+%)/g, '<span class="stat-highlight">$1</span>');
            statsHtml = statsHtml.replace(/(공속\s*[+-]?\s*\d+%)/g, '<span class="stat-highlight">$1</span>');

            const priceNumber = Number(item.dataset.price);
            const hasValidPrice = Number.isFinite(priceNumber);
            const formattedPrice = hasValidPrice ? priceNumber.toLocaleString() : '';
            
            const nameFromData = item.dataset.name ? escapeHtml(item.dataset.name) : '';
            const nameFromLine = firstLine.replace(/\s*[\d,.]+\s*$/, '').trim();
            const safeName = nameFromData || nameFromLine;

            const nameHtml = `<span class="item-name">${safeName}<span class="item-price">${formattedPrice}</span></span>`;
            const statsSection = statsHtml ? `<span class="item-stats">${statsHtml}</span>` : '';

            label.innerHTML = `${nameHtml}${statsSection}`;
        });
    }
    // 고정 전용 아이템 강제 규칙 적용
    function enforceFixedOnlyRules() {
      document.querySelectorAll('.item[data-fixed-only="true"]').forEach(itemEl => {
        const include = itemEl.querySelector('input.include');
        if (include) {
          include.checked = false;
          include.disabled = true;
          const chip = include.closest('label.chip');
          if (chip) chip.title = '고정 전용: 추천/포함 불가, 고정만 사용';
        }
      });
    }

    // --- 함수 정의 ---

    /** 주어진 포함 체크박스에서 아이템 데이터를 읽어옵니다 (부모 .item의 data-* 사용) */
    function getItemData(inputEl){
      const itemEl = inputEl.closest('.item');
      if(!itemEl) return { name:'', price:0, wp:0, as:0 };
      const name = itemEl.dataset.name || '';
      const price = +(itemEl.dataset.price || 0);
      const wp = +(itemEl.dataset.wp || 0);
      const as = +(itemEl.dataset.as || 0);
      return { name, price, wp, as };
    }

    function getEffectiveStats(inputEl) {
      const base = getItemData(inputEl);
      let wp = base.wp;
      let as = base.as;
      
      if (base.name === '바나듐 주사' && vanadiumToggle.checked) {
        wp += 10;
        as += 10;
      }
      if (base.name === '성전사 유압 시스템' && crusaderToggle.checked) {
        as += 5;
      }
      if (base.name === '슈퍼 혈청' && superSerumToggle && superSerumToggle.checked) {
        wp -= 15;
        as += 50;
      }

      return { ...base, wp, as };
    }

    /** 시나리오에 따른 보너스 무공 값을 가져옵니다. */
    function getScenarioBonus() {
      let am = 0, stackBonus = 0;
      if (lowHpInput.checked) am = 15;
      const stackSel = document.querySelector('input[name="stack"]:checked');
      if (stackSel) {
        if (stackSel.id === 'stack1') stackBonus = 5;
        if (stackSel.id === 'stack2') stackBonus = 10;
        if (stackSel.id === 'stack3') stackBonus = 15;
      }
      return { am, stackBonus };
    }
    
    /**
     * 주어진 아이템 목록을 기반으로 능력치를 계산합니다. (UI 업데이트 없음)
     * @param {HTMLElement[]} items - 계산할 아이템의 input 요소 배열
     * @returns {object} 계산된 능력치 객체
     */
    function calculateCoreStats(items) {
        const { am, stackBonus } = getScenarioBonus();
        let totalPrice = 0, wp = 0, aspd = 0;
        let hasAmari = false;
        let hasAccelerator = false;

        items.forEach(input => {
            const d = getEffectiveStats(input);
            totalPrice += d.price;
            wp += d.wp;
            aspd += d.as;
            if (d.name === '강화광 가속기') hasAccelerator = true;
            if (d.name === '아마리의 해독제') hasAmari = true;
        });
        
        if (hasAccelerator) {
            wp += stackBonus;
        }

        let healOn = baseHealing * (1 + wp / 100) * (1 + aspd / 100);
        let healOff = healOn;
        
        if (hasAmari && lowHpInput.checked) {
            healOn *= (1 + am / 100);
        }

        if (triageToggle.checked) {
            healOn *= 1.25;
            healOff *= 1.25;
        }

        let healString = healOn.toFixed(1);
        if (hasAmari && lowHpInput.checked) {
            healString = `${healOn.toFixed(1)} (${healOff.toFixed(1)})`;
        }

        return { totalPrice, wp, aspd, healString };
    }

    /**
     * 추천 조합 테이블과 결과 요약 UI를 업데이트합니다. (페이드 효과 포함)
     * @param {HTMLElement[]} items - 표시할 아이템의 input 요소 배열
     * @param {boolean} isInitial - 초기 로드 여부 (페이드 효과 비활성화)
     */
    function updateResultPanels(items, isInitial = false) {
        const stats = calculateCoreStats(items);
        
        const updateFn = () => {
            renderBestComboTable(items);
            totalPriceEl.textContent = stats.totalPrice.toLocaleString();
            totalWPEl.textContent = stats.wp;
            totalASEl.textContent = stats.aspd;
            healingEl.textContent = stats.healString;
        };
        
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (isInitial || prefersReducedMotion) {
            updateFn();
            return;
        }

        const elementsToFade = [bestComboTbody, totalPriceEl, totalWPEl, totalASEl, healingEl];
        elementsToFade.forEach(el => el.classList.add('is-fading-out'));

        setTimeout(() => {
            updateFn();
            elementsToFade.forEach(el => el.classList.remove('is-fading-out'));
        }, 500);
    }
    
    /** 현재 선택/고정된 아이템 목록을 가져옵니다. */
    function getCurrentlySelectedItems() {
        return includeInputs.filter((input, idx) => input.checked || pinInputs[idx].checked);
    }

    /** 현재 선택된 아이템 기준으로 계산하고 화면에 표시합니다. */
    function calculate(isInitial = false) {
      if (isCalculating && !isInitial) return;
      isCalculating = true;

      const selectedItems = getCurrentlySelectedItems();
      updateResultPanels(selectedItems, isInitial);
      
      setTimeout(() => { isCalculating = false; }, 50);
    }

    /** 예산과 아이템 수에 맞는 최적의 조합을 추천합니다. */
    function recommend() {
      if (recommendBtn.disabled) return;

      recommendBtn.disabled = true;
      const originalText = recommendBtn.textContent;
      recommendBtn.textContent = '계산 중...';

      setTimeout(() => {
        try {
          const budget = Math.max(0, +budgetInput.value || 0);
          const maxItems = Math.max(0, +maxItemsInput.value || 0);
          const { am, stackBonus } = getScenarioBonus();

          const pinned = includeInputs.filter((input, idx) => pinInputs[idx].checked);
          const pinnedStats = pinned.map(getEffectiveStats);
          const pinnedCost = pinnedStats.reduce((sum, d) => sum + d.price, 0);
          const pinnedWp = pinnedStats.reduce((sum, d) => sum + d.wp, 0);
          const pinnedAs = pinnedStats.reduce((sum, d) => sum + d.as, 0);
          const pinnedHasAm = pinnedStats.some(d => d.name === '아마리의 해독제');
          const pinnedHasAccelerator = pinnedStats.some(d => d.name === '강화광 가속기');

          const budgetLeft = budget - pinnedCost;
          const slotsLeft = maxItems - pinned.length;

          if (budgetLeft < 0 || slotsLeft < 0) {
            renderBestComboTable([]); // 빈 배열로 테이블 업데이트
            bestComboTbody.innerHTML = `<tr><td colspan="4">고정 아이템이 예산 또는 슬롯 제한을 초과했습니다.</td></tr>`;
            calculate(true);
            recommendBtn.disabled = false;
            recommendBtn.textContent = originalText;
            return;
          }

          const optional = includeInputs.filter(input => {
            const itemEl = input.closest('.item');
            return !pinned.includes(input) && !itemEl.dataset.fixedOnly && !input.disabled;
          });
          const optionalData = optional.map(input => ({ input, stats: getEffectiveStats(input) }));

          function evaluateState(state) {
            let totalWp = pinnedWp + state.wp;
            let totalAs = pinnedAs + state.as;
            const hasAmari = pinnedHasAm || state.hasAm;
            const hasAccelerator = pinnedHasAccelerator || state.hasAccelerator;
            if (hasAccelerator) totalWp += stackBonus;
            
            let heal = baseHealing * (1 + totalWp / 100) * (1 + totalAs / 100);
            if (hasAmari && lowHpInput.checked) {
              heal *= (1 + am / 100);
            }
            if (triageToggle.checked) {
                heal *= 1.25;
            }
            return heal;
          }

          const dp = Array.from({ length: Math.max(slotsLeft, 0) + 1 }, () => new Map());
          const initialState = { wp: 0, as: 0, hasAm: false, hasAccelerator: false, items: [] };
          initialState.heal = evaluateState(initialState);
          const EPSILON = 1e-9;

          function stateDominates(a, b) {
            if (a.heal + EPSILON < b.heal) return false;
            if (a.wp < b.wp) return false;
            if (a.as < b.as) return false;
            if (b.hasAm && !a.hasAm) return false;
            if (b.hasAccelerator && !a.hasAccelerator) return false;
            return true;
          }

          function insertState(map, cost, state) {
            const list = map.get(cost) || [];
            for (const existing of list) {
              if (stateDominates(existing, state)) {
                return;
              }
            }
            const filtered = list.filter(existing => !stateDominates(state, existing));
            filtered.push(state);
            map.set(cost, filtered);
          }

          insertState(dp[0], 0, initialState);

          optionalData.forEach(({ input, stats }) => {
            const maxCount = Math.min(slotsLeft - 1, dp.length - 2);
            for (let count = maxCount; count >= 0; count--) {
              const entries = Array.from(dp[count].entries());
              entries.forEach(([cost, states]) => {
                states.forEach(state => {
                  const newCost = cost + stats.price;
                  if (newCost > budgetLeft || count + 1 > slotsLeft) return;
                  const nextState = {
                    wp: state.wp + stats.wp,
                    as: state.as + stats.as,
                    hasAm: state.hasAm || stats.name === '아마리의 해독제',
                    hasAccelerator: state.hasAccelerator || stats.name === '강화광 가속기',
                    items: state.items.concat(input)
                  };
                  nextState.heal = evaluateState(nextState);
                  insertState(dp[count + 1], newCost, nextState);
                });
              });
            }
          });

          let bestState = initialState;
          for (let count = 0; count < dp.length; count++) {
            dp[count].forEach(states => {
              states.forEach(state => {
                if (!bestState || state.heal > bestState.heal) {
                  bestState = state;
                }
              });
            });
          }

          includeInputs.forEach(i => i.checked = false);
          pinned.forEach(input => {
            const index = includeInputs.indexOf(input);
            if (index !== -1) {
              pinInputs[index].checked = true;
              includeInputs[index].checked = true;
            }
          });
          (bestState.items || []).forEach(input => {
            const index = includeInputs.indexOf(input);
            if (index !== -1) {
              includeInputs[index].checked = true;
            }
          });
          
          const finalCombo = getCurrentlySelectedItems();
          updateResultPanels(finalCombo);
          saveState();

          recommendBtn.disabled = false;
          recommendBtn.textContent = originalText;
        } catch (err) {
          console.error(err);
          bestComboTbody.innerHTML = `<tr><td colspan="4">계산 중 오류가 발생했습니다.</td></tr>`;
          recommendBtn.disabled = false;
          recommendBtn.textContent = originalText;
        }
      }, 10);
    }

    /** 추천 조합 테이블 내용을 렌더링합니다. (HTML만 업데이트) */
    function renderBestComboTable(combo) {
        const rarityOrder = { green: 1, blue: 2, purple: 3 };
        combo.sort((a, b) => {
            const itemA = a.closest('.item');
            const itemB = b.closest('.item');
            if (!itemA || !itemB) return 0;

            const isPinnedA = itemA.querySelector('.pin').checked;
            const isPinnedB = itemB.querySelector('.pin').checked;
            if (isPinnedA !== isPinnedB) {
                return isPinnedB - isPinnedA;
            }

            const orderA = rarityOrder[itemA.dataset.rarity];
            const orderB = rarityOrder[itemB.dataset.rarity];
            if (orderA !== orderB) {
                return orderA - orderB;
            }

            const priceA = Number(itemA.dataset.price);
            const priceB = Number(itemB.dataset.price);
            return priceA - priceB;
        });

        bestComboTbody.innerHTML = '';
        if (combo.length === 0) {
          bestComboTbody.innerHTML = `<tr><td colspan="4">조건에 맞는 조합이 없습니다.</td></tr>`;
          return;
        }
        const { stackBonus } = getScenarioBonus();
        const hasAcceleratorInCombo = combo.some(i => getItemData(i).name === '강화광 가속기');

        combo.forEach(i => {
          const tr = document.createElement('tr');
          const itemDiv = i.closest('.item');
          const cls = itemDiv.dataset.rarity;
          const color = getComputedStyle(document.documentElement).getPropertyValue(`--${cls}`);
          const pinEl = itemDiv.querySelector('.pin');
          const isPinned = !!(pinEl && pinEl.checked);
          const base = getItemData(i);
          const stats = getEffectiveStats(i);
          let wpVal = stats.wp;
          if (base.name === '강화광 가속기' && hasAcceleratorInCombo) {
             wpVal += stackBonus;
          }
          const nameHtml = isPinned ? `<span title="고정 아이템" aria-label="고정 아이템" style="width:.55rem;height:.55rem;border-radius:50%;background:linear-gradient(135deg,#f1c40f,#f39c12);box-shadow:0 0 5px rgba(241,196,15,.35);display:inline-block;margin-right:.35rem;vertical-align:-1px;"></span>${base.name}` : base.name;
          tr.innerHTML = `
            <td style="color:${color}; font-weight:bold;">${nameHtml}</td>
            <td>${stats.price.toLocaleString()}</td>
            <td>${wpVal}</td>
            <td>${stats.as}</td>
          `;
          bestComboTbody.appendChild(tr);
        });
    }

    /** 자동 추천을 위한 디바운스 핸들러 */
    function triggerAutoRecommend() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(recommend, 500);
    }

    /** 모든 이벤트 리스너를 등록합니다. */
    function addEventListeners() {
        calcItemsBtn.addEventListener('click', () => calculate());
        recommendBtn.addEventListener('click', recommend);
        if (editItemsBtn) {
            editItemsBtn.addEventListener('click', toggleEditMode);
        }

        budgetInput.addEventListener('click', () => budgetInput.select());
        maxItemsInput.addEventListener('click', () => maxItemsInput.select());

        budgetInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                recommend();
            }
        });

        // 설정 변경 시 자동으로 추천 기능 실행
        budgetInput.addEventListener('input', () => { triggerAutoRecommend(); saveState(); });
        maxItemsInput.addEventListener('input', () => { triggerAutoRecommend(); saveState(); });
        lowHpInput.addEventListener('change', () => { triggerAutoRecommend(); saveState(); });
        stackRadios.forEach(radio => radio.addEventListener('change', () => { triggerAutoRecommend(); saveState(); }));
        vanadiumToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        crusaderToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        if (superSerumToggle) {
            superSerumToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        }
        triageToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });

        // 아이템 체크박스 변경 시
        includeInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (input.dataset.name === '아마리의 해독제') {
                    lowHpInput.checked = input.checked;
                }
                calculate(); saveState();
            });
        });
        pinInputs.forEach(pin => pin.addEventListener('change', () => { triggerAutoRecommend(); saveState(); }));

        toggleScenarioBtn.addEventListener('click', () => {
            const isHidden = scenarioContent.style.display === 'none';
            scenarioContent.style.display = isHidden ? '' : 'none';
            toggleScenarioBtn.textContent = isHidden ? '▼ 접기' : '▲ 펼치기';
        });

        itemSearchInput.addEventListener('input', () => {
            const searchTerm = itemSearchInput.value.toLowerCase().trim();
            itemCards.forEach(item => {
                const itemName = item.dataset.name.toLowerCase();
                const isMatch = itemName.includes(searchTerm);
                
                item.style.display = 'grid'; // 항상 보이도록 설정

                if (searchTerm === '') {
                    item.style.order = '0';
                } else {
                    if (isMatch) {
                        item.style.order = '-1'; // 일치하는 아이템을 위로
                    } else {
                        item.style.order = '0'; // 일치하지 않는 아이템은 기본 순서
                    }
                }
            });
        });

        window.addEventListener('beforeunload', saveState);

        if (toggleZeroStatsBtn) {
            toggleZeroStatsBtn.addEventListener('click', () => {
                const zeroItems = getZeroStatItems();
                if (zeroItems.length === 0) return;
                const shouldHide = toggleZeroStatsBtn.dataset.active !== 'true';
                zeroItems.forEach(item => setItemHiddenState(item, shouldHide));
                refreshItemVisibility();
                saveState();
            });
        }
    }

    // 페이지 로드 완료 후 실행
    initialize();
  });
</script>
</body>
</html>