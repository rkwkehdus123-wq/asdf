<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° & ìµœì  ì¡°í•© ì¶”ì²œ</title>
  <!-- SEO: basic + OpenGraph + Twitter -->
  <link rel="canonical" href="https://majestic-cocada-b2c63d.netlify.app/">
  <meta name="description" content="ì˜¤ë²„ì›Œì¹˜ ìŠ¤íƒ€ë””ì›€ìš© ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° &amp; ìµœì  ì¡°í•© ì¶”ì²œ. ì˜ˆì‚°Â·ì•„ì´í…œÂ·ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¼ HPSë¥¼ ìë™ìœ¼ë¡œ ìµœëŒ€í™”í•©ë‹ˆë‹¤.">
  <meta name="robots" content="index,follow">
  
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° & ìµœì  ì¡°í•© ì¶”ì²œ">
  <meta property="og:description" content="ì˜ˆì‚°ê³¼ ì•„ì´í…œìœ¼ë¡œ HPS ìµœì í™”! ì•„ë§ˆë¦¬/ê°•í™”ê´‘ ì‹œë‚˜ë¦¬ì˜¤ ë°˜ì˜, ì¦‰ì‹œ ê³„ì‚°.">
  <meta property="og:url" content="https://majestic-cocada-b2c63d.netlify.app/">
  <meta property="og:image" content="https://majestic-cocada-b2c63d.netlify.app/og.png">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° & ìµœì  ì¡°í•© ì¶”ì²œ">
  <meta name="twitter:description" content="ìŠ¤íƒ€ë””ì›€ ë©”ë¥´ì‹œ ìœ ì €ë¥¼ ìœ„í•œ HPS ìµœì í™” ê³„ì‚°ê¸°.">
  <meta name="twitter:image" content="https://majestic-cocada-b2c63d.netlify.app/og.png">
  
  <!-- êµ¬ì¡°í™” ë°ì´í„°(JSON-LD) -->
  <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° & ìµœì  ì¡°í•© ì¶”ì²œ",
    "url": "https://majestic-cocada-b2c63d.netlify.app/",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Web",
    "description": "ì˜¤ë²„ì›Œì¹˜ ìŠ¤íƒ€ë””ì›€ìš© ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸°. ì˜ˆì‚°/ì•„ì´í…œ/ì‹œë‚˜ë¦¬ì˜¤ë¡œ HPSë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.",
    "offers": {"@type": "Offer", "price": "0", "priceCurrency": "KRW"}
  }</script>
  <style>
    /* í°íŠ¸ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

    :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --primary-color: #0f3460;
        --secondary-color: #e94560;
        --text-color: #e0e0e0;
        --border-color: #2a3a5e;
        --green: #2ecc71;
        --blue: #3498db;
        --purple: #9b59b6;
    }

    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 1rem;
        line-height: 1.6;
    }

    /* ë ˆì´ì•„ì›ƒ */
    .container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 1400px;
        margin: auto;
    }

    /* ë°ìŠ¤í¬íƒ‘ í™”ë©´ì—ì„œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ì ìš© */
    @media (min-width: 1024px) {
        .container {
            grid-template-columns: repeat(3, 1fr);
            grid-template-areas:
                "header header header"
                "controls scenario results"
                "items items items";
        }
        h1 { grid-area: header; }
        .controls { grid-area: controls; }
        .scenario { grid-area: scenario; }
        .item-list { grid-area: items; }
        .results { grid-area: results; }
    }

    /* ê³µí†µ ìš”ì†Œ */
    h1, h2, h3 {
        color: var(--secondary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
        margin-top: 0;
    }
    h1 {
        text-align: center;
        font-size: 2.2rem;
        margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.4rem;
    }
    h2 small {
      font-size: 0.9rem;
      color: var(--text-color);
    }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ ì„¹ì…˜ */
    .controls, .scenario, .item-list, .results {
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
    }

    /* ë²„íŠ¼ */
    button {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 1rem;
    }
    button:hover:not(:disabled) {
        background-color: #ff6b81;
        transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #recommend {
        width: 100%;
        margin-top: 1rem;
    }

    /* ì…ë ¥ í•„ë“œ & ë¼ë²¨ */
    label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }
    input[type="number"], input[type="search"] {
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.5rem;
        font-size: 1rem;
    }
    input[type="number"] { width: 80px; }
    input[type="search"] { flex-grow: 1; max-width: 250px; }

    input[type="checkbox"], input[type="radio"] {
        accent-color: var(--secondary-color);
        width: 1.3em;
        height: 1.3em;
        cursor: pointer;
    }

    /* ì‹œë‚˜ë¦¬ì˜¤ ì„¹ì…˜ */
    .scenario-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    #toggleScenario {
        background: none;
        color: var(--text-color);
        padding: 0.2rem 0.5rem;
        align-self: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        margin-bottom: -1rem; /* ì½˜í…ì¸ ì™€ì˜ ê°„ê²© ì¡°ì ˆ */
    }
    .scen-item label {
      font-size: 0.9rem;
    }

    /* ì•„ì´í…œ ëª©ë¡ */
    .item-list h2 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .item-list-actions {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
        flex-wrap: wrap;
    }
    #editItems {
        background: rgba(233, 69, 96, 0.16);
        border: 1px solid rgba(233, 69, 96, 0.35);
        color: var(--text-color);
    }
    #editItems:hover:not(:disabled) {
        background: rgba(233, 69, 96, 0.25);
    }
    .item-list.editing #editItems {
        background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 0 14px rgba(233, 69, 96, 0.35);
    }
    #toggleZeroStats {
        background: rgba(92, 141, 255, 0.16);
        border: 1px solid rgba(92, 141, 255, 0.35);
        color: var(--text-color);
    }
    #toggleZeroStats[aria-pressed="true"] {
        background: linear-gradient(135deg, rgba(92, 141, 255, 0.45), rgba(52, 94, 199, 0.65));
        border-color: transparent;
        color: #fff;
        box-shadow: 0 0 14px rgba(92, 141, 255, 0.35);
    }
    .item-category {
      margin-top: 2rem;
    }
    .item-category:first-child {
      margin-top: 1rem;
    }
    .item-category h3 {
      font-size: 1.6rem;
      color: var(--text-color);
      border-bottom-color: var(--secondary-color);
      margin-bottom: 1.2rem;
    }
    .item-list-content {
        display: grid;
        gap: 1.1rem;
        margin-top: 0;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        align-content: start;
    }
    @media (min-width: 1440px) {
        .item-list-content {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }
    }
    .item {
        position: relative;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.85rem 1.1rem;
        padding: 1.05rem 1.1rem 1.05rem 1.15rem;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: linear-gradient(135deg, rgba(15, 52, 96, 0.78), rgba(22, 33, 62, 0.65));
        --item-glow: 0 12px 28px rgba(0, 0, 0, 0.45);
        box-shadow: var(--item-glow);
        transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease, order 0.3s ease;
        overflow: hidden;
    }
    .item::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), transparent 60%);
        opacity: 0.45;
        pointer-events: none;
    }
    .item:hover {
        transform: translateY(-3px);
        box-shadow: var(--item-glow), 0 16px 32px rgba(15, 52, 96, 0.45);
    }
    .item.green { border-left: 6px solid var(--green); --item-glow: 0 12px 26px rgba(46, 204, 113, 0.18); }
    .item.blue { border-left: 6px solid var(--blue); --item-glow: 0 12px 26px rgba(52, 152, 219, 0.18); }
    .item.purple { border-left: 6px solid var(--purple); --item-glow: 0 12px 26px rgba(155, 89, 182, 0.18); }
    .item:has(.include:checked) {
        box-shadow: var(--item-glow), 0 0 0 1px rgba(233, 69, 96, 0.45), 0 0 20px rgba(233, 69, 96, 0.32);
    }
    .item:has(.pin:checked) {
        box-shadow: var(--item-glow), 0 0 0 1px rgba(241, 196, 15, 0.55), 0 0 26px rgba(241, 196, 15, 0.4);
    }
    .item.green::after,
    .item.blue::after,
    .item.purple::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        opacity: 0.18;
        pointer-events: none;
    }
    .item.green::after { background: radial-gradient(circle at top right, rgba(46,204,113,0.55), transparent 55%); }
    .item.blue::after { background: radial-gradient(circle at top right, rgba(52,152,219,0.55), transparent 55%); }
    .item.purple::after { background: radial-gradient(circle at top right, rgba(155,89,182,0.55), transparent 55%); }

    @media (max-width: 640px) {
        .item {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        .item-controls {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 0.75rem;
            grid-row: auto;
        }
    }

    .item-visibility-toggle {
        position: absolute;
        top: 0.45rem;
        right: 0.45rem;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(15, 52, 96, 0.45);
        color: #fff;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        z-index: 2;
    }
    .item-visibility-toggle:hover {
        background: rgba(233, 69, 96, 0.45);
        border-color: rgba(233, 69, 96, 0.65);
    }
    .item-visibility-toggle.is-hidden {
        background: rgba(233, 69, 96, 0.3);
        border-color: rgba(233, 69, 96, 0.5);
    }
    .item-list.editing .item-visibility-toggle {
        opacity: 1;
        pointer-events: auto;
    }
    .item--hidden {
        opacity: 0.38;
        filter: grayscale(55%);
    }
    .item--collapsed {
        display: none !important;
    }

    .item-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 0.55rem;
        grid-row: span 2;
        z-index: 1;
    }
    .item-controls label {
        margin-bottom: 0;
        font-size: 0.95rem;
    }
    .item-controls label.chip {
        padding: 0.45rem 0.9rem;
        font-size: 0.9rem;
        letter-spacing: -0.01em;
        background: rgba(15, 52, 96, 0.4);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 10px 16px rgba(0, 0, 0, 0.25);
    }
    .item-controls label.chip span {
        font-weight: 600;
    }
    .item-label {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        font-weight: 500;
        text-align: left;
        line-height: 1.45;
        z-index: 1;
    }
    .item-label .item-name {
        display: inline-flex;
        align-items: baseline;
        gap: 0.4rem;
        font-weight: 700;
        font-size: 1.05rem;
        color: #ffffff;
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
    }
    .item-label .item-price {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(15, 52, 96, 0.55);
        color: rgba(224, 224, 224, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }
    .item.green .item-label .item-price { color: rgba(214, 255, 227, 0.92); border-color: rgba(46, 204, 113, 0.35); background: rgba(46, 204, 113, 0.14); }
    .item.blue .item-label .item-price { color: rgba(214, 235, 255, 0.92); border-color: rgba(52, 152, 219, 0.35); background: rgba(52, 152, 219, 0.16); }
    .item.purple .item-label .item-price { color: rgba(238, 218, 255, 0.92); border-color: rgba(155, 89, 182, 0.35); background: rgba(155, 89, 182, 0.16); }
    .item-label .item-stats {
        font-size: 0.95rem;
        color: rgba(224, 224, 224, 0.85);
    }
    .item-label .item-stats .stat-highlight {
        color: #ffffff;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.07);
        padding: 0.1em 0.35em;
        border-radius: 5px;
        margin: 0 0.1em;
    }
    .item-label small {
        display: inline-block;
        margin-top: 0.2rem;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
    }

    /* ê²°ê³¼ & í…Œì´ë¸” */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    th, td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    th {
        color: var(--secondary-color);
    }
    #bestCombo, #totalPrice, #totalWP, #totalAS, #healing {
      transition: opacity 0.3s ease;
    }
    .is-fading-out {
        opacity: 0 !important;
    }
    #totalPrice, #totalWP, #totalAS { font-size: 1.2rem; font-weight: 700; color: #ffffff; text-shadow: none; }
    /* ê°•ì¡° ìŠ¤íƒ€ì¼: ì˜ˆìƒ íëŸ‰ í•˜ì´ë¼ì´íŠ¸ */
    .healing-row { background: none; }
    .healing-row th, .healing-row td { border-bottom: none; padding-top: 0.5rem; padding-bottom: 0.5rem; }
    #healing {
      font-size: 2.4rem;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 107, 129, 0.7);
      white-space: nowrap;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      padding: 0.18rem 0.6rem 0.26rem 0.6rem;
      margin-right: 0.35rem;
      background-image: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.35), inset 0 1px 1px rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    }
    .healing-unit { opacity: 0.95; white-space: nowrap; }
    /* ê²°ê³¼ í‘œëŠ” í•­ìƒ í•œ ì¤„ë¡œ í‘œì‹œ */
    .results table th, .results table td { white-space: nowrap; }
    @media (max-width: 480px) { #healing { font-size: 2rem; padding: 0.14rem 0.5rem 0.22rem 0.5rem; } }
  
    /* =============================
       THEME-CONSISTENT FORM CONTROLS
       ============================= */

    /* Focus ring for keyboard users */
    :where(input,button):focus-visible { outline: 2px solid var(--secondary-color); outline-offset: 2px; }

    /* ---------- ITEM LIST: include/pin chips (pill buttons) ---------- */
    .item-list .item-controls { display:flex; flex-direction:column; align-items:flex-start; gap: .4rem; }
    .item-list .item-controls input[type="checkbox"]{ position:absolute; opacity:0; width:0; height:0; }
    .item-list .item-controls label.chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .95rem; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(12,26,54,.65); color:var(--text-color); cursor:pointer; user-select:none; font-size:.88rem; font-weight:600; line-height:1; white-space:nowrap; transition:background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .05s ease; }
    .item-list .item-controls label.chip:hover{ border-color:rgba(124,163,255,.55); background:rgba(33,56,102,.75); }
    .item-list .item-controls label.chip:active{ transform:scale(.97); }
    .item-list .item-controls label.chip::before{ content:""; width:.95rem; height:.95rem; display:inline-block; background: #95a5b6; mask-size:contain; mask-repeat:no-repeat; mask-position:center; -webkit-mask-size:contain; -webkit-mask-repeat:no-repeat; -webkit-mask-position:center; filter: drop-shadow(0 0 6px rgba(149,165,182,.5)); }
    /* include icon (check) */
    .item-list .item-controls label.include-chip::before{ mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M9 16.2 4.8 12l-1.8 1.8L9 19.8 21 7.8 19.2 6z"/></svg>'); -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M9 16.2 4.8 12l-1.8 1.8L9 19.8 21 7.8 19.2 6z'/></svg>"); }
    /* pin icon (star) */
    .item-list .item-controls label.pin-chip::before{ mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="m12 17.3-5.56 3.27 1.48-6.36L3 9.97l6.56-.56L12 3.5l2.44 5.91 6.56.56-4.92 4.24 1.48 6.36z"/></svg>'); -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='m12 17.3-5.56 3.27 1.48-6.36L3 9.97l6.56-.56L12 3.5l2.44 5.91 6.56.56-4.92 4.24 1.48 6.36z'/></svg>"); }
    /* checked state */
    /* per-type checked states */
    .item-list .item-controls label.include-chip:has(input:checked){ background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%); border-color: transparent; color:#fff; box-shadow: 0 0 12px rgba(233,69,96,.35); }
    .item-list .item-controls label.include-chip:has(input:checked)::before{ background:#fff; }
    .item-list .item-controls label.pin-chip:has(input:checked){ background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); border-color: rgba(241,196,15,.85); color:#1a1a2e; box-shadow: 0 0 14px rgba(241,196,15,.45), 0 0 28px rgba(241,196,15,.25); }
    .item-list .item-controls label.pin-chip:has(input:checked)::before{ background:#1a1a2e; }
    .item-list .item-controls label.chip:has(input:checked)::before{ background:#fff; }

    /* ---------- SCENARIO: radio group & checkbox toggles as pills ---------- */
    .stack-scenarios .scen-item { display: inline-block; }
    .stack-scenarios .scen-item input[type="radio"],
    .stack-scenarios .scen-item input[type="checkbox"] { 
      position: absolute; opacity: 0; width: 0; height: 0; 
    }
    .stack-scenarios .scen-item input[type="radio"] + label,
    .stack-scenarios .scen-item input[type="checkbox"] + label {
      display: inline-block; margin: .25rem .35rem .25rem 0; padding: .4rem .8rem;
      border: 1px solid var(--border-color); border-radius: 999px;
      background: rgba(255,255,255,0.04); color: var(--text-color);
      transition: background .2s ease, border-color .2s ease, transform .05s ease, box-shadow .2s ease;
      cursor: pointer; user-select: none; font-size: .95rem;
    }
    .stack-scenarios .scen-item input[type="radio"] + label:hover,
    .stack-scenarios .scen-item input[type="checkbox"] + label:hover {
      border-color: rgba(233,69,96,0.55); background: rgba(233,69,96,0.08);
    }
    .stack-scenarios .scen-item input[type="radio"]:focus-visible + label,
    .stack-scenarios .scen-item input[type="checkbox"]:focus-visible + label { 
      box-shadow: 0 0 0 3px rgba(233,69,96,0.35); 
    }
    .stack-scenarios .scen-item input[type="radio"]:checked + label,
    .stack-scenarios .scen-item input[type="checkbox"]:checked + label {
      color: #fff; border-color: rgba(233,69,96,0.65);
      background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35), 0 0 0 2px rgba(233,69,96,0.22) inset;
    }

    /* ---------- SCENARIO: low-HP switch ---------- */
    .am-scenarios .scen-item { position: relative; }
    .am-scenarios .scen-item input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .am-scenarios .scen-item input[type="checkbox"] + label {
      position: relative; padding-left: 3.2rem; min-height: 1.6rem; display: inline-flex; align-items: center;
    }
    .am-scenarios .scen-item input[type="checkbox"] + label::before {
      content: ""; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
      width: 2.6rem; height: 1.4rem; border-radius: 999px;
      background: #0b1530; border: 1px solid var(--border-color);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.5);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .am-scenarios .scen-item input[type="checkbox"] + label::after {
      content: ""; position: absolute; left: .18rem; top: 50%; transform: translateY(-50%);
      width: 1.05rem; height: 1.05rem; border-radius: 50%;
      background: #233449; box-shadow: 0 2px 4px rgba(0,0,0,.4);
      transition: left .22s ease, background .2s ease;
    }
    .am-scenarios .scen-item input[type="checkbox"]:checked + label::before {
      background: linear-gradient(135deg, #e94560 0%, #ff6b81 100%); border-color: transparent;
      box-shadow: 0 0 12px rgba(233,69,96,0.35) inset;
    }
    .am-scenarios .scen-item input[type="checkbox"]:checked + label::after { left: 1.35rem; background: #fff; }

    /* Ghost style for scenario toggler */
    #toggleScenario { border: 1px solid var(--border-color); border-radius: 999px; }
    #toggleScenario:hover { border-color: #3c4f7f; }

  
    /* ---------- LAYOUT: radio pills as responsive flex rows (2 columns) ---------- */
    .stack-scenarios { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: .6rem; align-items: stretch; }
    .stack-scenarios > h3 { grid-column: 1 / -1; margin-bottom: .25rem; }
    .stack-scenarios .scen-item { display: block; margin: 0;}
    .stack-scenarios .scen-item input[type="radio"] + label,
    .stack-scenarios .scen-item input[type="checkbox"] + label {
      display: flex; align-items: center; justify-content: center; width: 100%;
      margin: 0; min-height: 44px; box-sizing: border-box; padding: .6rem .9rem;
    }
    @media (max-width: 560px) { .stack-scenarios { grid-template-columns: 1fr; } }

  
    /* ---- Micro interactions & responsive enhancements ---- */
    @keyframes pop { 0% { transform: scale(.98); } 100% { transform: scale(1); } }
    .stack-scenarios .scen-item input[type="radio"]:checked + label,
    .stack-scenarios .scen-item input[type="checkbox"]:checked + label { 
      animation: pop 120ms ease-out; 
    }
    .item-list .item-controls input[type="checkbox"]:checked { animation: pop 120ms ease-out; }
    @media (min-width:1280px) { .stack-scenarios { grid-template-columns: repeat(2, minmax(0,1fr)); } }

    /* Tooltip(help) */
    .am-scenarios .scen-item label .help { display:inline-flex; align-items:center; justify-content:center; width:1.05rem; height:1.05rem; margin-left:.35rem; border-radius:50%; border:1px solid var(--border-color); background:rgba(255,255,255,.06); font-weight:700; font-size:.78rem; line-height:1; cursor:help; }

  </style>
</head>
<body>
<div class="container">
  <h1>ë©”ë¥´ì‹œ íëŸ‰ ê³„ì‚°ê¸° & ìµœì  ì¡°í•© ì¶”ì²œ</h1>
  
  <div class="controls">
    <h2>ê¸°ë³¸ ì„¤ì •</h2>
    <label>ë³´ìœ  ì¬í™”: <input type="number" id="budget" value="20000" min="0" step="1"></label>
    <label>ì•„ì´í…œ ìˆ˜: <input type="number" id="maxItems" value="6" min="1" max="12"></label>
    <button id="recommend">ìµœì  ì¡°í•© ì¶”ì²œ</button>
  </div>

  <div class="scenario">
    <button id="toggleScenario">â–¼ ì ‘ê¸°</button>
    <h2>ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •</h2>
    <div class="scenario-content">
      <div class="am-scenarios">
        <h3>ì•„ë§ˆë¦¬ í•´ë…ì œ</h3>
        <div class="scen-item"><input type="checkbox" id="chkLowHp"><label for="chkLowHp">ì €ì²´ë ¥ íšŒë³µ (HP&lt;50%, ë¬´ê¸° ì¹˜ìœ ëŸ‰ +15%)<span class="help" title="HP 50% ë¯¸ë§Œì¼ ë•Œ ë©”ë¥´ì‹œ ë¬´ê¸° ì¹˜ìœ ëŸ‰ì— +15%ê°€ ê³±ì—°ì‚°ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.">?</span></label></div>
      </div>
      <div class="am-scenarios">
        <h3>ë¶€ìƒì ë¶„ë¥˜ì†Œ</h3>
        <div class="scen-item">
          <input type="checkbox" id="chkTriage">
          <label for="chkTriage">ì¹˜ìœ ëŸ‰ 25%ì¦ê°€</label>
        </div>
      </div>
      <div class="stack-scenarios">
        <h3>ê°•í™”ê´‘ ê°€ì†ê¸°</h3>
        <div class="scen-item"><input type="radio" name="stack" value="stack0" id="stack-none" checked><label for="stack-none">ì¤‘ì²© ì—†ìŒ (+0% ë¬´ê³µ)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack1" id="stack1"><label for="stack1">1ì¤‘ì²© (+5% ë¬´ê³µ)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack2" id="stack2"><label for="stack2">2ì¤‘ì²© (+10% ë¬´ê³µ)</label></div>
        <div class="scen-item"><input type="radio" name="stack" value="stack3" id="stack3"><label for="stack3">3ì¤‘ì²© (+15% ë¬´ê³µ)</label></div>
      </div>
      <div class="stack-scenarios">
        <h3>ì¡°ê±´ë¶€ íš¨ê³¼</h3>
        <div class="scen-item">
          <input type="checkbox" id="chkVanadium">
          <label for="chkVanadium">ë°”ë‚˜ë“ ì£¼ì‚¬</label>
        </div>
        <div class="scen-item">
          <input type="checkbox" id="chkCrusader">
          <label for="chkCrusader">ì„±ì „ì‚¬ ìœ ì•• ì‹œìŠ¤í…œ</label>
        </div>
        <div class="scen-item">
          <input type="checkbox" id="chkSuperSerum">
          <label for="chkSuperSerum">ìŠˆí¼ í˜ˆì²­</label>
        </div>
      </div>
    </div>
  </div>

  <div class="results">
    <h3>ì¶”ì²œ ì¡°í•©</h3>
    <table>
      <thead><tr><th>ì•„ì´í…œ</th><th>ê°€ê²©</th><th>ë¬´ê³µ%</th><th>ê³µì†%</th></tr></thead>
      <tbody id="bestCombo"><tr><td colspan="4">ì¶”ì²œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</td></tr></tbody>
    </table>
    
    <h2 style="margin-top: 1.5rem;">ê²°ê³¼ ìš”ì•½</h2>
    <table>
      <tr class="healing-row"><th>ì˜ˆìƒ íëŸ‰</th><td><span id="healing">60.0</span></td><th class="healing-unit">hps</th></tr>
      <tr><th>ì´ ë¹„ìš©</th><td id="totalPrice">0</td><th>ì¬í™”</th></tr>
      <tr><th>ì´ ë¬´ê³µ</th><td id="totalWP">0</td><th>%</th></tr>
      <tr><th>ì´ ê³µì†</th><td id="totalAS">0</td><th>%</th></tr>
    </table>
  </div>

  <div class="item-list">
    <h2>ì•„ì´í…œ ëª©ë¡ <small>(í¬í•¨/ê³ ì • í† ê¸€)</small>
      <div class="item-list-actions">
        <input type="search" id="itemSearch" placeholder="ì•„ì´í…œ ê²€ìƒ‰...">
        <button id="editItems" type="button">ì•„ì´í…œ ëª©ë¡ í¸ì§‘</button>
        <button id="toggleZeroStats" type="button" class="toggle-zero-stats" hidden aria-pressed="false">ë¬´ê³µ/ê³µì† ì—†ëŠ” ì•„ì´í…œ ìˆ¨ê¸°ê¸°</button>
        <button id="calcItems" type="button">ì„ íƒ ì•„ì´í…œ ê³„ì‚°</button>
      </div>
    </h2>

    <div id="item-container">
      <!-- Items will be injected here by JavaScript -->
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
    const budgetInput = document.getElementById('budget');
    const maxItemsInput = document.getElementById('maxItems');
    const recommendBtn = document.getElementById('recommend');
    const calcItemsBtn = document.getElementById('calcItems');
    const toggleScenarioBtn = document.getElementById('toggleScenario');
    const scenarioContent = document.querySelector('.scenario-content');
    const itemContainer = document.getElementById('item-container');
    const itemSearchInput = document.getElementById('itemSearch');

    let includeInputs = [];
    let pinInputs = [];
    const lowHpInput = document.getElementById('chkLowHp');
    const stackRadios = document.querySelectorAll('input[name="stack"]');
    const vanadiumToggle = document.getElementById('chkVanadium');
    const crusaderToggle = document.getElementById('chkCrusader');
    const superSerumToggle = document.getElementById('chkSuperSerum');
    const triageToggle = document.getElementById('chkTriage');
    const editItemsBtn = document.getElementById('editItems');
    const toggleZeroStatsBtn = document.getElementById('toggleZeroStats');
    const itemListEl = document.querySelector('.item-list');
    let itemCards = [];

    const totalPriceEl = document.getElementById('totalPrice');
    const totalWPEl = document.getElementById('totalWP');
    const totalASEl = document.getElementById('totalAS');
    const healingEl = document.getElementById('healing');
    const bestComboTbody = document.getElementById('bestCombo');

    let isCalculating = false;

    const itemData = {
      weapon: [
        { name: 'ë¬´ê¸° ê¸°ë¦„ì¹ ', price: 1000, wp: 0, as: 5, rarity: 'green', description: 'ê³µì†+5%' },
        { name: 'ë³´ì •ê¸°', price: 1000, wp: 5, as: 0, rarity: 'green', description: 'ë¬´ê³µ+5%' },
        { name: 'ë¶€í’ˆ ì‹œì¥ ë°œì‚¬ í•€', price: 3750, wp: 0, as: 10, rarity: 'blue', description: 'ê³µì†+10%' },
        { name: 'ê³ ê¸‰ ë‚˜ë…¸ìƒë¬¼í•™', price: 4000, wp: 5, as: 10, rarity: 'blue', description: 'ë¬´ê³µ+5%, ê³µì†+10%' },
        { name: 'ê³µì¤‘ ê¸°ë™ê¸°', price: 4000, wp: 5, as: 10, rarity: 'blue', description: 'ë¬´ê³µ+5%, ê³µì†+10%(ê³ ì • ì „ìš©)', fixedOnly: true },
        { name: 'ê½‰ ì±„ìš´ ì”', price: 4500, wp: 0, as: 5, rarity: 'blue', description: 'ê³µì†+5%' },
        { name: 'ì°¨ê°€ìš´ ëƒ‰ê°ìˆ˜', price: 5500, wp: 10, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+10%' },
        { name: 'íƒˆë¡  ê°œì¡° ëª¨ë“ˆ', price: 6000, wp: 15, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+15%' },
        { name: 'ê³µì¤‘ ì¡°ë‚œì', price: 9000, wp: 0, as: 10, rarity: 'purple', description: 'ê³µì†+10%' },
        { name: 'ì½”ë“œë¸Œë ˆì´ì»¤', price: 10000, wp: 15, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+15%' },
        { name: 'íšŒìˆ˜ ì‚°íƒ„', price: 9000, wp: 0, as: 10, rarity: 'purple', description: 'ê³µì†+10%' },
        { name: 'ë³¼ìŠ¤ì¹´ì•¼ êµ°ìˆ˜í’ˆ', price: 9500, wp: 0, as: 10, rarity: 'purple', description: 'ê³µì†+10%' },
        { name: 'ë¬´ê¸° ì¬ë¨¸', price: 10000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ì‚¬ë ¹ê´€ì˜ íƒ„ì°½', price: 10000, wp: 0, as: 10, rarity: 'purple', description: 'ê³µì†+10%' },
        { name: 'ì¹´ë‘ì„¸ìš°ìŠ¤ ì—°ì¥ê¸°', price: 10000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ì²œìƒì˜ íƒ„ì°½', price: 10000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ê°•í™”ê´‘ ê°€ì†ê¸°', price: 11000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ë¶€ìŠ¤í„° ì œíŠ¸', price: 11000, wp: 0, as: 20, rarity: 'purple', description: 'ê³µì†+20%' },
        { name: 'ì•„ë§ˆë¦¬ì˜ í•´ë…ì œ', price: 11000, wp: 15, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+15% (HP<50%)' },
        { name: 'ì—˜ì‚¬ê°€ ì œì••ê¸°', price: 11000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ê±°ë¯¸ì˜ ëˆˆ', price: 14000, wp: 25, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+25%' },
        { name: 'ì¢…ê²°ì', price: 14500, wp: 20, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+20%' },
      ],
      tech: [
        { name: 'ìˆ˜ìƒì©ì€ ì¥ê´€', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¶©ì „ íŒê°‘', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'íŒŒì›Œ ì „ìˆ ', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ìŠ¹ë¦¬ì˜ íƒœë„', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë§ì¶¤í˜• ê°œë¨¸ë¦¬íŒ', price: 3750, wp: 5, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+5%' },
        { name: 'ìƒì²´ê´‘ ì˜¤ë²„í”Œë¡œ', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì†ëª© ì‹¸ê°œ', price: 4000, wp: 0, as: 10, rarity: 'blue', description: 'ê³µì†+10%' },
        { name: 'ìŠ¤ì¹´ì´ë¼ì¸ ë‚˜ë…¸ë¨¸ì‹ ', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì“°ë ˆê¸°ì´Œ ë­ë”ë¼', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì—ë„ˆì§€ ì¶©ì „ ì†ëª© ë°©ì–´êµ¬', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¥ê±°ë¦¬ ë‚ ê°œ', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ë‹¤ìš©ë„ ë„êµ¬', price: 4500, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'í™œë ¥ ì¦í­ê¸°', price: 5000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë‚˜ë…¸ ì½œë¼', price: 6000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¶•ë³µë°›ì€ ë¶€ìŠ¤í„°', price: 9000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ìŒíŒŒ ì¬ì¶©ì „', price: 9000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: '3ì—°ì† í† ë¯¸ê±´ ë°œì‚¬', price: 9500, wp: 0, as: 10, rarity: 'purple', description: 'ê³µì†+10%' },
        { name: 'ë£¨ë©”ë¦¬ì½” ìœµí•© ê¸°ê´€í¬', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ìƒì²´ê¸°ìˆ  ê·¹ëŒ€í™”', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì´ˆêµ´ê·¼', price: 10000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ì´‰ë§¤ ìˆ˜ì •', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë¶€í™œ ê±°ë¦¬ ì¸¡ì •ê¸°', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ì‚¬ì´ë²„ë² ë†ˆ', price: 10500, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ê´‘ì±„ ëˆˆë™ì', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì•¡ì²´ì§ˆì†Œ', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì—¬ìš°ì˜ ì§•í‘œ', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì²œì‚¬ì˜ ê³¡ì˜ˆ', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ì±”í”¼ì–¸ì˜ ë„êµ¬', price: 14000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
      ],
      survival: [
        { name: 'ëŸ¬ë‹í™”', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì „íˆ¬ì‹ëŸ‰', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì „í•´ì•¡', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'íƒ„ë„ ì™„í™”', price: 1000, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë°˜ì‚¬ ì½”íŒ…', price: 1500, wp: 0, as: 0, rarity: 'green', description: '' },
        { name: 'ì•„ë“œë ˆë‚ ë¦° ì£¼ì‚¬', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì‘ê¸‰ ì¹˜ë£Œ í‚¤íŠ¸', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¥ê°‘ ì¡°ë¼', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'í¡ìˆ˜ ì¥ê°‘', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ê°•ì²  ëˆˆ', price: 3750, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ê°•í™” í‹°íƒ€ëŠ„', price: 3750, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë¹„ìŠˆì¹´ë¥´ ì½˜ë´ì„œ', price: 3750, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì™„ì¶©ì¬', price: 3750, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'Eìƒëª…ë ¥', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì² ê°‘ ë°°ê¸°êµ¬', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ê³µê¸°ì—­í•™ì  ê¹ƒí„¸', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ì²œì‚¬ì˜ ë ˆì € ë³µì¥', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'í”¼ì˜ êµ¬ì†', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì„±ì „ì‚¬ ìœ ì•• ì‹œìŠ¤í…œ', price: 4500, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%', note: 'ì¡°ê±´ë¶€ í™œì„±í™” ì‹œ ê³µì†+5%' },
        { name: 'ë©”ì¹´ Z ì‹œë¦¬ì¦ˆ', price: 5000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ìœ ì „í•™ìì˜ ì•½ë³‘', price: 9000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì‹ ì„±í•œ ê°œì…', price: 9500, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì˜¤ë²„ë“œë¼ì´ë¸Œ í•µ', price: 9500, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ë¤¼ìŠ¤í‰ í° ë¹Œí—¬ë¦„', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë°”ë‚˜ë“ ì£¼ì‚¬', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%', note: 'ì¡°ê±´ë¶€ í™œì„±í™” ì‹œ ë¬´ê³µ+10%, ê³µì†+10%' },
        { name: 'ì–´ë‘ ì˜ ê±´í‹€ë¦¿', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'í™”ì„±ì˜ ìˆ˜ë¦¬ê³µ', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'í™˜ì˜ ìœ ì…', price: 10000, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%' },
        { name: 'ì—°ì‡„ ìœ ë°œê¸°', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%'},
        { name: 'ì„±ìš´ ì „ë„', price: 11000, wp: 5, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+5%' },
        { name: 'ì˜¤êµ°ë””ë¬´ ê°ì†Œì¥', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
      ],
      gadget: [
        { name: 'ì˜¤ë¼ ê²©í‡´', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ë°©ë²½ íŒŒí¸', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì™¸ê³¨ê²© ìŠ¤í”„ë§', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ê¹ƒí„¸ ë‹¬ë¦° ë°‘ì°½', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'êµ¬ê¸‰ìƒì', price: 1500, wp: 0, as: 0, rarity: 'green', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì§ˆì£¼ ìŠ¤ì¼€ì´íŠ¸', price: 3750, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì•¼ì „ ì§€ì›', price: 4000, wp: 5, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+5%, ê³µì†+0%' },
        { name: 'ì—¬ìš°ë‹˜ íŒŒí¸', price: 4000, wp: 0, as: 0, rarity: 'blue', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¹´ë„¤ìì¹´ ë¶€ì ', price: 9000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì œíŠ¸ ìŠ¤ì¼€ì´íŒ…', price: 9500, wp: 10, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+10%, ê³µì†+0%' },
        { name: 'ê´´ì € ë°©ì§€ì œ', price: 10000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ìŠˆí¼ í˜ˆì²­', price: 10000, wp: 0, as: 10, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+10%', note: 'ì¡°ê±´ë¶€ í™œì„±í™” ì‹œ ë¬´ê³µ-15%, ê³µì†+50%' },
        { name: 'ê±°ìƒ í•µ', price: 11000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
        { name: 'ì¬ì •ë¹„', price: 13000, wp: 0, as: 0, rarity: 'purple', description: 'ë¬´ê³µ+0%, ê³µì†+0%' },
      ],
    };

    const slugify = (name = '') => name.replace(/\s+/g, '');

    function createItemCard(item, categoryKey) {
      const card = document.createElement('div');
      const idBase = item.id || slugify(item.name);
      card.className = `item ${item.rarity}`;
      card.id = `item-${idBase}`;
      card.dataset.name = item.name;
      card.dataset.price = String(item.price);
      card.dataset.wp = String(item.wp);
      card.dataset.as = String(item.as);
      card.dataset.category = categoryKey;
      card.dataset.rarity = item.rarity;
      if (item.fixedOnly) {
        card.dataset.fixedOnly = 'true';
      }

      const controls = document.createElement('div');
      controls.className = 'item-controls';

      const includeLabel = document.createElement('label');
      includeLabel.title = 'í¬í•¨';
      includeLabel.className = 'chip include-chip';
      includeLabel.innerHTML = '<input type="checkbox" class="include"><span>í¬í•¨</span>';

      const pinLabel = document.createElement('label');
      pinLabel.title = 'ê³ ì •';
      pinLabel.className = 'chip pin-chip';
      pinLabel.innerHTML = '<input type="checkbox" class="pin"><span>ê³ ì •</span>';

      controls.append(includeLabel, pinLabel);

      const label = document.createElement('span');
      label.className = 'item-label';
      let labelHtml = `${item.name} ${item.price.toLocaleString()}<br>${item.description}`;
      if (item.note) {
        labelHtml += `<br><small>${item.note}</small>`;
      }
      label.innerHTML = labelHtml;

      card.append(controls, label);
      return card;
    }

    function renderItems() {
      itemContainer.innerHTML = ''; // Clear previous items
      const categoryMap = {
        weapon: 'ë¬´ê¸°',
        tech: 'ê¸°ìˆ ',
        survival: 'ìƒì¡´',
        gadget: 'ê°€ì ¯'
      };

      Object.entries(itemData).forEach(([categoryKey, items]) => {
        const categoryWrapper = document.createElement('div');
        categoryWrapper.className = 'item-category';

        const categoryTitle = document.createElement('h3');
        categoryTitle.textContent = categoryMap[categoryKey];
        categoryWrapper.appendChild(categoryTitle);

        const contentGrid = document.createElement('div');
        contentGrid.className = 'item-list-content';
        
        items.forEach(item => {
          contentGrid.appendChild(createItemCard(item, categoryKey));
        });

        categoryWrapper.appendChild(contentGrid);
        itemContainer.appendChild(categoryWrapper);
      });
    }

    function refreshItemReferences() {
      includeInputs = Array.from(document.querySelectorAll('.include'));
      pinInputs = Array.from(document.querySelectorAll('.pin'));
      itemCards = Array.from(document.querySelectorAll('.item-list .item'));
    }

    renderItems();
    refreshItemReferences();

    // --- ìƒìˆ˜ ì •ì˜ ---
    const baseHealing = 60;
    let debounceTimer;
    let hiddenItemNames = new Set();
    let isEditingItems = false;

    includeInputs.forEach((input, idx) => {
      const data = getItemData(input);
      input.dataset.name = data.name;
      if (pinInputs[idx]) {
        pinInputs[idx].dataset.name = data.name;
      }
    });

    function setupItemVisibilityControls() {
      itemCards.forEach(item => {
        if (item.querySelector('.item-visibility-toggle')) return;
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'item-visibility-toggle';
        toggleBtn.textContent = 'ğŸ‘€';
        const labelName = item.dataset.name || 'ì•„ì´í…œ';
        toggleBtn.title = 'ì•„ì´í…œ í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜';
        toggleBtn.setAttribute('aria-label', `${labelName} í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜`);
        toggleBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const willHide = item.dataset.hidden === 'true' ? false : true;
          setItemHiddenState(item, willHide);
          saveState();
        });
        item.insertAdjacentElement('afterbegin', toggleBtn);
      });
    }

    function syncItemDisplay(item) {
      const isHidden = item.dataset.hidden === 'true';
      if (isEditingItems) {
        item.classList.remove('item--collapsed');
        item.classList.toggle('item--hidden', isHidden);
      } else {
        item.classList.remove('item--hidden');
        item.classList.toggle('item--collapsed', isHidden);
      }
      const toggleBtn = item.querySelector('.item-visibility-toggle');
      if (toggleBtn) {
        toggleBtn.setAttribute('aria-pressed', isHidden ? 'true' : 'false');
        toggleBtn.classList.toggle('is-hidden', isHidden);
      }
    }

    function setItemHiddenState(item, hidden) {
      if (!item) return;
      const name = item.dataset.name || '';
      if (hidden) {
        if (name) hiddenItemNames.add(name);
      } else if (name) {
        hiddenItemNames.delete(name);
      }
      const currentlyHidden = item.dataset.hidden === 'true';
      item.dataset.hidden = hidden ? 'true' : 'false';
      if (hidden === currentlyHidden) {
        syncItemDisplay(item);
        updateZeroStatButtonState();
        return;
      }
      syncItemDisplay(item);
      updateZeroStatButtonState();
    }

    function isZeroStatItem(item) {
      if (!item) return false;
      const wp = Number(item.dataset.wp);
      const as = Number(item.dataset.as);
      const wpVal = Number.isFinite(wp) ? wp : 0;
      const asVal = Number.isFinite(as) ? as : 0;
      return wpVal === 0 && asVal === 0;
    }

    function getZeroStatItems() {
      return itemCards.filter(isZeroStatItem);
    }

    function updateZeroStatButtonState() {
      if (!toggleZeroStatsBtn) return;
      const zeroItems = getZeroStatItems();
      if (zeroItems.length === 0) {
        toggleZeroStatsBtn.disabled = true;
        toggleZeroStatsBtn.dataset.active = 'false';
        toggleZeroStatsBtn.setAttribute('aria-pressed', 'false');
        toggleZeroStatsBtn.textContent = 'ë¬´ê³µ/ê³µì† ì—†ëŠ” ì•„ì´í…œ ìˆ¨ê¸°ê¸°';
        toggleZeroStatsBtn.title = 'ë¬´ê³µê³¼ ê³µì†ì´ ëª¨ë‘ 0ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      toggleZeroStatsBtn.disabled = false;
      const allHidden = zeroItems.every(item => item.dataset.hidden === 'true');
      toggleZeroStatsBtn.dataset.active = allHidden ? 'true' : 'false';
      toggleZeroStatsBtn.setAttribute('aria-pressed', allHidden ? 'true' : 'false');
      toggleZeroStatsBtn.textContent = allHidden ? 'ìˆ¨ê¸´ ì•„ì´í…œ ë³µì›' : 'ë¬´ê³µ/ê³µì† ì—†ëŠ” ì•„ì´í…œ ìˆ¨ê¸°ê¸°';
      toggleZeroStatsBtn.title = allHidden ? 'ìˆ¨ê¸´ ì•„ì´í…œì„ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤.' : 'ë¬´ê³µê³¼ ê³µì†ì´ ëª¨ë‘ 0ì¸ ì•„ì´í…œì„ ìˆ¨ê¹ë‹ˆë‹¤.';
    }

    function refreshItemVisibility() {
      itemCards.forEach(syncItemDisplay);
      updateZeroStatButtonState();
    }

    function applyHiddenStateFromStorage() {
      itemCards.forEach(item => {
        const name = item.dataset.name || '';
        const shouldHide = name ? hiddenItemNames.has(name) : false;
        setItemHiddenState(item, shouldHide);
      });
      refreshItemVisibility();
    }

    function enterEditMode() {
      if (!itemListEl) return;
      isEditingItems = true;
      itemListEl.classList.add('editing');
      if (editItemsBtn) {
        editItemsBtn.textContent = 'í¸ì§‘ ì™„ë£Œ';
        editItemsBtn.setAttribute('aria-pressed', 'true');
      }
      if (toggleZeroStatsBtn) {
        toggleZeroStatsBtn.hidden = false;
        updateZeroStatButtonState();
      }
      refreshItemVisibility();
    }

    function exitEditMode() {
      if (!itemListEl) return;
      isEditingItems = false;
      itemListEl.classList.remove('editing');
      if (editItemsBtn) {
        editItemsBtn.textContent = 'ì•„ì´í…œ ëª©ë¡ í¸ì§‘';
        editItemsBtn.setAttribute('aria-pressed', 'false');
      }
      if (toggleZeroStatsBtn) {
        toggleZeroStatsBtn.hidden = true;
      }
      refreshItemVisibility();
    }

    function toggleEditMode() {
      if (isEditingItems) {
        exitEditMode();
      } else {
        enterEditMode();
      }
    }

    // --- ìƒíƒœ ì €ì¥(LocalStorage) ---
    const STORAGE_KEY = 'mercy_heal_calc_v1';

    function saveState() {
      try {
        const includes = includeInputs.filter(i => i.checked).map(i => i.dataset.name).filter(Boolean);
        const pins = pinInputs.map((p, idx) => p.checked ? includeInputs[idx].dataset.name : null).filter(Boolean);
        const stackSel = document.querySelector('input[name="stack"]:checked');
        const hiddenItems = itemCards
          .filter(item => item.dataset.hidden === 'true')
          .map(item => item.dataset.name)
          .filter(Boolean);
        const data = {
          budget: +budgetInput.value || 0,
          maxItems: +maxItemsInput.value || 6,
          lowHp: !!lowHpInput.checked,
          stackId: stackSel ? stackSel.id : 'stack-none',
          includes,
          pins,
          vanadiumActive: vanadiumToggle.checked,
          crusaderActive: crusaderToggle.checked,
          superSerumActive: superSerumToggle ? superSerumToggle.checked : false,
          triageActive: triageToggle.checked,
          hiddenItems,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) { /* noop */ }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.budget != null) budgetInput.value = data.budget;
        if (data.maxItems != null) maxItemsInput.value = data.maxItems;
        if (typeof data.lowHp === 'boolean') lowHpInput.checked = data.lowHp;
        if (data.stackId) {
          const r = document.getElementById(data.stackId);
          if (r) r.checked = true;
        }
        if (typeof data.vanadiumActive === 'boolean') vanadiumToggle.checked = data.vanadiumActive;
        if (typeof data.crusaderActive === 'boolean') crusaderToggle.checked = data.crusaderActive;
        if (typeof data.superSerumActive === 'boolean' && superSerumToggle) superSerumToggle.checked = data.superSerumActive;
        if (typeof data.triageActive === 'boolean') triageToggle.checked = data.triageActive;

        includeInputs.forEach(i => i.checked = false);
        pinInputs.forEach(p => p.checked = false);
        if (Array.isArray(data.includes)) {
          includeInputs.forEach(i => { if (data.includes.includes(i.dataset.name)) i.checked = true; });
        }
        if (Array.isArray(data.pins)) {
          pinInputs.forEach((p, idx) => { if (data.pins.includes(includeInputs[idx].dataset.name)) p.checked = true; });
        }
        if (Array.isArray(data.hiddenItems)) {
          hiddenItemNames = new Set(data.hiddenItems);
        } else {
          hiddenItemNames = new Set();
        }
      } catch (e) { /* noop */ }
    }

    // --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
    function initialize() {
        formatItemPrices();
        setupItemVisibilityControls();
        addEventListeners();
        loadState();
        enforceFixedOnlyRules();
        applyHiddenStateFromStorage();
        exitEditMode();
        calculate(true); // ì´ˆê¸° ë¡œë“œ ì‹œ ì¦‰ì‹œ ê³„ì‚°
    }

    /** ì•„ì´í…œ ëª©ë¡ì˜ ê°€ê²©ì— ì½¤ë§ˆë¥¼ ì¶”ê°€í•˜ê³  ê´„í˜¸ë¥¼ ì œê±°í•©ë‹ˆë‹¤. */
    function formatItemPrices() {
        const escapeHtml = (str = '') => str.replace(/[&<>"']/g, ch => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
        }[ch] || ch));
        
        document.querySelectorAll('.item').forEach(item => {
            const label = item.querySelector('.item-label');
            if (!label) return;

            const original = label.dataset.original ?? label.innerHTML;
            label.dataset.original = original;

            const segments = original.split('<br>');
            const firstLine = (segments.shift() || '').trim();
            let statsHtml = segments.join('<br>').trim();
            
            statsHtml = statsHtml.replace(/(ë¬´ê³µ\s*[+-]?\s*\d+%)/g, '<span class="stat-highlight">$1</span>');
            statsHtml = statsHtml.replace(/(ê³µì†\s*[+-]?\s*\d+%)/g, '<span class="stat-highlight">$1</span>');

            const priceNumber = Number(item.dataset.price);
            const hasValidPrice = Number.isFinite(priceNumber);
            const formattedPrice = hasValidPrice ? priceNumber.toLocaleString() : '';
            
            const nameFromData = item.dataset.name ? escapeHtml(item.dataset.name) : '';
            const nameFromLine = firstLine.replace(/\s*[\d,.]+\s*$/, '').trim();
            const safeName = nameFromData || nameFromLine;

            const nameHtml = `<span class="item-name">${safeName}<span class="item-price">${formattedPrice}</span></span>`;
            const statsSection = statsHtml ? `<span class="item-stats">${statsHtml}</span>` : '';

            label.innerHTML = `${nameHtml}${statsSection}`;
        });
    }
    // ê³ ì • ì „ìš© ì•„ì´í…œ ê°•ì œ ê·œì¹™ ì ìš©
    function enforceFixedOnlyRules() {
      document.querySelectorAll('.item[data-fixed-only="true"]').forEach(itemEl => {
        const include = itemEl.querySelector('input.include');
        if (include) {
          include.checked = false;
          include.disabled = true;
          const chip = include.closest('label.chip');
          if (chip) chip.title = 'ê³ ì • ì „ìš©: ì¶”ì²œ/í¬í•¨ ë¶ˆê°€, ê³ ì •ë§Œ ì‚¬ìš©';
        }
      });
    }

    // --- í•¨ìˆ˜ ì •ì˜ ---

    /** ì£¼ì–´ì§„ í¬í•¨ ì²´í¬ë°•ìŠ¤ì—ì„œ ì•„ì´í…œ ë°ì´í„°ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤ (ë¶€ëª¨ .itemì˜ data-* ì‚¬ìš©) */
    function getItemData(inputEl){
      const itemEl = inputEl.closest('.item');
      if(!itemEl) return { name:'', price:0, wp:0, as:0 };
      const name = itemEl.dataset.name || '';
      const price = +(itemEl.dataset.price || 0);
      const wp = +(itemEl.dataset.wp || 0);
      const as = +(itemEl.dataset.as || 0);
      return { name, price, wp, as };
    }

    function getEffectiveStats(inputEl) {
      const base = getItemData(inputEl);
      let wp = base.wp;
      let as = base.as;
      
      if (base.name === 'ë°”ë‚˜ë“ ì£¼ì‚¬' && vanadiumToggle.checked) {
        wp += 10;
        as += 10;
      }
      if (base.name === 'ì„±ì „ì‚¬ ìœ ì•• ì‹œìŠ¤í…œ' && crusaderToggle.checked) {
        as += 5;
      }
      if (base.name === 'ìŠˆí¼ í˜ˆì²­' && superSerumToggle && superSerumToggle.checked) {
        wp -= 15;
        as += 50;
      }

      return { ...base, wp, as };
    }

    /** ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ ë¬´ê³µ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. */
    function getScenarioBonus() {
      let am = 0, stackBonus = 0;
      if (lowHpInput.checked) am = 15;
      const stackSel = document.querySelector('input[name="stack"]:checked');
      if (stackSel) {
        if (stackSel.id === 'stack1') stackBonus = 5;
        if (stackSel.id === 'stack2') stackBonus = 10;
        if (stackSel.id === 'stack3') stackBonus = 15;
      }
      return { am, stackBonus };
    }
    
    /**
     * ì£¼ì–´ì§„ ì•„ì´í…œ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ëŠ¥ë ¥ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (UI ì—…ë°ì´íŠ¸ ì—†ìŒ)
     * @param {HTMLElement[]} items - ê³„ì‚°í•  ì•„ì´í…œì˜ input ìš”ì†Œ ë°°ì—´
     * @returns {object} ê³„ì‚°ëœ ëŠ¥ë ¥ì¹˜ ê°ì²´
     */
    function calculateCoreStats(items) {
        const { am, stackBonus } = getScenarioBonus();
        let totalPrice = 0, wp = 0, aspd = 0;
        let hasAmari = false;
        let hasAccelerator = false;

        items.forEach(input => {
            const d = getEffectiveStats(input);
            totalPrice += d.price;
            wp += d.wp;
            aspd += d.as;
            if (d.name === 'ê°•í™”ê´‘ ê°€ì†ê¸°') hasAccelerator = true;
            if (d.name === 'ì•„ë§ˆë¦¬ì˜ í•´ë…ì œ') hasAmari = true;
        });
        
        if (hasAccelerator) {
            wp += stackBonus;
        }

        let healOn = baseHealing * (1 + wp / 100) * (1 + aspd / 100);
        let healOff = healOn;
        
        if (hasAmari && lowHpInput.checked) {
            healOn *= (1 + am / 100);
        }

        if (triageToggle.checked) {
            healOn *= 1.25;
            healOff *= 1.25;
        }

        let healString = healOn.toFixed(1);
        if (hasAmari && lowHpInput.checked) {
            healString = `${healOn.toFixed(1)} (${healOff.toFixed(1)})`;
        }

        return { totalPrice, wp, aspd, healString };
    }

    /**
     * ì¶”ì²œ ì¡°í•© í…Œì´ë¸”ê³¼ ê²°ê³¼ ìš”ì•½ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (í˜ì´ë“œ íš¨ê³¼ í¬í•¨)
     * @param {HTMLElement[]} items - í‘œì‹œí•  ì•„ì´í…œì˜ input ìš”ì†Œ ë°°ì—´
     * @param {boolean} isInitial - ì´ˆê¸° ë¡œë“œ ì—¬ë¶€ (í˜ì´ë“œ íš¨ê³¼ ë¹„í™œì„±í™”)
     */
    function updateResultPanels(items, isInitial = false) {
        const stats = calculateCoreStats(items);
        
        const updateFn = () => {
            renderBestComboTable(items);
            totalPriceEl.textContent = stats.totalPrice.toLocaleString();
            totalWPEl.textContent = stats.wp;
            totalASEl.textContent = stats.aspd;
            healingEl.textContent = stats.healString;
        };
        
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (isInitial || prefersReducedMotion) {
            updateFn();
            return;
        }

        const elementsToFade = [bestComboTbody, totalPriceEl, totalWPEl, totalASEl, healingEl];
        elementsToFade.forEach(el => el.classList.add('is-fading-out'));

        setTimeout(() => {
            updateFn();
            elementsToFade.forEach(el => el.classList.remove('is-fading-out'));
        }, 500);
    }
    
    /** í˜„ì¬ ì„ íƒ/ê³ ì •ëœ ì•„ì´í…œ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. */
    function getCurrentlySelectedItems() {
        return includeInputs.filter((input, idx) => input.checked || pinInputs[idx].checked);
    }

    /** í˜„ì¬ ì„ íƒëœ ì•„ì´í…œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
    function calculate(isInitial = false) {
      if (isCalculating && !isInitial) return;
      isCalculating = true;

      const selectedItems = getCurrentlySelectedItems();
      updateResultPanels(selectedItems, isInitial);
      
      setTimeout(() => { isCalculating = false; }, 50);
    }

    /** ì˜ˆì‚°ê³¼ ì•„ì´í…œ ìˆ˜ì— ë§ëŠ” ìµœì ì˜ ì¡°í•©ì„ ì¶”ì²œí•©ë‹ˆë‹¤. */
    function recommend() {
      if (recommendBtn.disabled) return;

      recommendBtn.disabled = true;
      const originalText = recommendBtn.textContent;
      recommendBtn.textContent = 'ê³„ì‚° ì¤‘...';

      setTimeout(() => {
        try {
          const budget = Math.max(0, +budgetInput.value || 0);
          const maxItems = Math.max(0, +maxItemsInput.value || 0);
          const { am, stackBonus } = getScenarioBonus();

          const pinned = includeInputs.filter((input, idx) => pinInputs[idx].checked);
          const pinnedStats = pinned.map(getEffectiveStats);
          const pinnedCost = pinnedStats.reduce((sum, d) => sum + d.price, 0);
          const pinnedWp = pinnedStats.reduce((sum, d) => sum + d.wp, 0);
          const pinnedAs = pinnedStats.reduce((sum, d) => sum + d.as, 0);
          const pinnedHasAm = pinnedStats.some(d => d.name === 'ì•„ë§ˆë¦¬ì˜ í•´ë…ì œ');
          const pinnedHasAccelerator = pinnedStats.some(d => d.name === 'ê°•í™”ê´‘ ê°€ì†ê¸°');

          const budgetLeft = budget - pinnedCost;
          const slotsLeft = maxItems - pinned.length;

          if (budgetLeft < 0 || slotsLeft < 0) {
            renderBestComboTable([]); // ë¹ˆ ë°°ì—´ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            bestComboTbody.innerHTML = `<tr><td colspan="4">ê³ ì • ì•„ì´í…œì´ ì˜ˆì‚° ë˜ëŠ” ìŠ¬ë¡¯ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
            calculate(true);
            recommendBtn.disabled = false;
            recommendBtn.textContent = originalText;
            return;
          }

          const optional = includeInputs.filter(input => {
            const itemEl = input.closest('.item');
            return !pinned.includes(input) && !itemEl.dataset.fixedOnly && !input.disabled;
          });
          const optionalData = optional.map(input => ({ input, stats: getEffectiveStats(input) }));

          function evaluateState(state) {
            let totalWp = pinnedWp + state.wp;
            let totalAs = pinnedAs + state.as;
            const hasAmari = pinnedHasAm || state.hasAm;
            const hasAccelerator = pinnedHasAccelerator || state.hasAccelerator;
            if (hasAccelerator) totalWp += stackBonus;
            
            let heal = baseHealing * (1 + totalWp / 100) * (1 + totalAs / 100);
            if (hasAmari && lowHpInput.checked) {
              heal *= (1 + am / 100);
            }
            if (triageToggle.checked) {
                heal *= 1.25;
            }
            return heal;
          }

          const dp = Array.from({ length: Math.max(slotsLeft, 0) + 1 }, () => new Map());
          const initialState = { wp: 0, as: 0, hasAm: false, hasAccelerator: false, items: [] };
          initialState.heal = evaluateState(initialState);
          const EPSILON = 1e-9;

          function stateDominates(a, b) {
            if (a.heal + EPSILON < b.heal) return false;
            if (a.wp < b.wp) return false;
            if (a.as < b.as) return false;
            if (b.hasAm && !a.hasAm) return false;
            if (b.hasAccelerator && !a.hasAccelerator) return false;
            return true;
          }

          function insertState(map, cost, state) {
            const list = map.get(cost) || [];
            for (const existing of list) {
              if (stateDominates(existing, state)) {
                return;
              }
            }
            const filtered = list.filter(existing => !stateDominates(state, existing));
            filtered.push(state);
            map.set(cost, filtered);
          }

          insertState(dp[0], 0, initialState);

          optionalData.forEach(({ input, stats }) => {
            const maxCount = Math.min(slotsLeft - 1, dp.length - 2);
            for (let count = maxCount; count >= 0; count--) {
              const entries = Array.from(dp[count].entries());
              entries.forEach(([cost, states]) => {
                states.forEach(state => {
                  const newCost = cost + stats.price;
                  if (newCost > budgetLeft || count + 1 > slotsLeft) return;
                  const nextState = {
                    wp: state.wp + stats.wp,
                    as: state.as + stats.as,
                    hasAm: state.hasAm || stats.name === 'ì•„ë§ˆë¦¬ì˜ í•´ë…ì œ',
                    hasAccelerator: state.hasAccelerator || stats.name === 'ê°•í™”ê´‘ ê°€ì†ê¸°',
                    items: state.items.concat(input)
                  };
                  nextState.heal = evaluateState(nextState);
                  insertState(dp[count + 1], newCost, nextState);
                });
              });
            }
          });

          let bestState = initialState;
          for (let count = 0; count < dp.length; count++) {
            dp[count].forEach(states => {
              states.forEach(state => {
                if (!bestState || state.heal > bestState.heal) {
                  bestState = state;
                }
              });
            });
          }

          includeInputs.forEach(i => i.checked = false);
          pinned.forEach(input => {
            const index = includeInputs.indexOf(input);
            if (index !== -1) {
              pinInputs[index].checked = true;
              includeInputs[index].checked = true;
            }
          });
          (bestState.items || []).forEach(input => {
            const index = includeInputs.indexOf(input);
            if (index !== -1) {
              includeInputs[index].checked = true;
            }
          });
          
          const finalCombo = getCurrentlySelectedItems();
          updateResultPanels(finalCombo);
          saveState();

          recommendBtn.disabled = false;
          recommendBtn.textContent = originalText;
        } catch (err) {
          console.error(err);
          bestComboTbody.innerHTML = `<tr><td colspan="4">ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>`;
          recommendBtn.disabled = false;
          recommendBtn.textContent = originalText;
        }
      }, 10);
    }

    /** ì¶”ì²œ ì¡°í•© í…Œì´ë¸” ë‚´ìš©ì„ ë Œë”ë§í•©ë‹ˆë‹¤. (HTMLë§Œ ì—…ë°ì´íŠ¸) */
    function renderBestComboTable(combo) {
        const rarityOrder = { green: 1, blue: 2, purple: 3 };
        combo.sort((a, b) => {
            const itemA = a.closest('.item');
            const itemB = b.closest('.item');
            if (!itemA || !itemB) return 0;

            const isPinnedA = itemA.querySelector('.pin').checked;
            const isPinnedB = itemB.querySelector('.pin').checked;
            if (isPinnedA !== isPinnedB) {
                return isPinnedB - isPinnedA;
            }

            const orderA = rarityOrder[itemA.dataset.rarity];
            const orderB = rarityOrder[itemB.dataset.rarity];
            if (orderA !== orderB) {
                return orderA - orderB;
            }

            const priceA = Number(itemA.dataset.price);
            const priceB = Number(itemB.dataset.price);
            return priceA - priceB;
        });

        bestComboTbody.innerHTML = '';
        if (combo.length === 0) {
          bestComboTbody.innerHTML = `<tr><td colspan="4">ì¡°ê±´ì— ë§ëŠ” ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          return;
        }
        const { stackBonus } = getScenarioBonus();
        const hasAcceleratorInCombo = combo.some(i => getItemData(i).name === 'ê°•í™”ê´‘ ê°€ì†ê¸°');

        combo.forEach(i => {
          const tr = document.createElement('tr');
          const itemDiv = i.closest('.item');
          const cls = itemDiv.dataset.rarity;
          const color = getComputedStyle(document.documentElement).getPropertyValue(`--${cls}`);
          const pinEl = itemDiv.querySelector('.pin');
          const isPinned = !!(pinEl && pinEl.checked);
          const base = getItemData(i);
          const stats = getEffectiveStats(i);
          let wpVal = stats.wp;
          if (base.name === 'ê°•í™”ê´‘ ê°€ì†ê¸°' && hasAcceleratorInCombo) {
             wpVal += stackBonus;
          }
          const nameHtml = isPinned ? `<span title="ê³ ì • ì•„ì´í…œ" aria-label="ê³ ì • ì•„ì´í…œ" style="width:.55rem;height:.55rem;border-radius:50%;background:linear-gradient(135deg,#f1c40f,#f39c12);box-shadow:0 0 5px rgba(241,196,15,.35);display:inline-block;margin-right:.35rem;vertical-align:-1px;"></span>${base.name}` : base.name;
          tr.innerHTML = `
            <td style="color:${color}; font-weight:bold;">${nameHtml}</td>
            <td>${stats.price.toLocaleString()}</td>
            <td>${wpVal}</td>
            <td>${stats.as}</td>
          `;
          bestComboTbody.appendChild(tr);
        });
    }

    /** ìë™ ì¶”ì²œì„ ìœ„í•œ ë””ë°”ìš´ìŠ¤ í•¸ë“¤ëŸ¬ */
    function triggerAutoRecommend() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(recommend, 500);
    }

    /** ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤. */
    function addEventListeners() {
        calcItemsBtn.addEventListener('click', () => calculate());
        recommendBtn.addEventListener('click', recommend);
        if (editItemsBtn) {
            editItemsBtn.addEventListener('click', toggleEditMode);
        }

        budgetInput.addEventListener('click', () => budgetInput.select());
        maxItemsInput.addEventListener('click', () => maxItemsInput.select());

        budgetInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                recommend();
            }
        });

        // ì„¤ì • ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì¶”ì²œ ê¸°ëŠ¥ ì‹¤í–‰
        budgetInput.addEventListener('input', () => { triggerAutoRecommend(); saveState(); });
        maxItemsInput.addEventListener('input', () => { triggerAutoRecommend(); saveState(); });
        lowHpInput.addEventListener('change', () => { triggerAutoRecommend(); saveState(); });
        stackRadios.forEach(radio => radio.addEventListener('change', () => { triggerAutoRecommend(); saveState(); }));
        vanadiumToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        crusaderToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        if (superSerumToggle) {
            superSerumToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });
        }
        triageToggle.addEventListener('change', () => { calculate(); triggerAutoRecommend(); saveState(); });

        // ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ
        includeInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (input.dataset.name === 'ì•„ë§ˆë¦¬ì˜ í•´ë…ì œ') {
                    lowHpInput.checked = input.checked;
                }
                calculate(); saveState();
            });
        });
        pinInputs.forEach(pin => pin.addEventListener('change', () => { triggerAutoRecommend(); saveState(); }));

        toggleScenarioBtn.addEventListener('click', () => {
            const isHidden = scenarioContent.style.display === 'none';
            scenarioContent.style.display = isHidden ? '' : 'none';
            toggleScenarioBtn.textContent = isHidden ? 'â–¼ ì ‘ê¸°' : 'â–² í¼ì¹˜ê¸°';
        });

        itemSearchInput.addEventListener('input', () => {
            const searchTerm = itemSearchInput.value.toLowerCase().trim();
            itemCards.forEach(item => {
                const itemName = item.dataset.name.toLowerCase();
                const isMatch = itemName.includes(searchTerm);
                
                item.style.display = 'grid'; // í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì •

                if (searchTerm === '') {
                    item.style.order = '0';
                } else {
                    if (isMatch) {
                        item.style.order = '-1'; // ì¼ì¹˜í•˜ëŠ” ì•„ì´í…œì„ ìœ„ë¡œ
                    } else {
                        item.style.order = '0'; // ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì€ ê¸°ë³¸ ìˆœì„œ
                    }
                }
            });
        });

        window.addEventListener('beforeunload', saveState);

        if (toggleZeroStatsBtn) {
            toggleZeroStatsBtn.addEventListener('click', () => {
                const zeroItems = getZeroStatItems();
                if (zeroItems.length === 0) return;
                const shouldHide = toggleZeroStatsBtn.dataset.active !== 'true';
                zeroItems.forEach(item => setItemHiddenState(item, shouldHide));
                refreshItemVisibility();
                saveState();
            });
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    initialize();
  });
</script>
</body>
</html>